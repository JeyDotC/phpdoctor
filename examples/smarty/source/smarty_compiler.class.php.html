<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Sun, 25 Apr 2010 10:36:57 +0100">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>Smarty_Compiler.class.php (Smarty)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>Smarty</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/smarty_compiler.class.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>Smarty_Compiler.class.php</h1>
<div class="comment" id="overview_description"><p>Project:     Smarty: the PHP compiling template engine
File:        Smarty_Compiler.class.php</p><p>This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.</p><p>This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.</p><p>You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</p></div>

<hr>

<a name="line1"></a><pre class="php" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">&lt;?php</span>
<a name="line2"></a>&nbsp;
<a name="line3"></a><span style="color: #009933; font-style: italic;">/**
<a name="line4"></a> * Project:     Smarty: the PHP compiling template engine
<a name="line5"></a> * File:        Smarty_Compiler.class.php
<a name="line6"></a> *
<a name="line7"></a> * This library is free software; you can redistribute it and/or
<a name="line8"></a> * modify it under the terms of the GNU Lesser General Public
<a name="line9"></a> * License as published by the Free Software Foundation; either
<a name="line10"></a> * version 2.1 of the License, or (at your option) any later version.
<a name="line11"></a> *
<a name="line12"></a> * This library is distributed in the hope that it will be useful,
<a name="line13"></a> * but WITHOUT ANY WARRANTY; without even the implied warranty of
<a name="line14"></a> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
<a name="line15"></a> * Lesser General Public License for more details.
<a name="line16"></a> *
<a name="line17"></a> * You should have received a copy of the GNU Lesser General Public
<a name="line18"></a> * License along with this library; if not, write to the Free Software
<a name="line19"></a> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
<a name="line20"></a> *
<a name="line21"></a> * @link http://www.smarty.net/
<a name="line22"></a> * @author Monte Ohrt &lt;monte at ohrt dot com&gt;
<a name="line23"></a> * @author Andrei Zmievski &lt;andrei@php.net&gt;
<a name="line24"></a> * @version 2.6.22
<a name="line25"></a> * @copyright 2001-2005 New Digital Group, Inc.
<a name="line26"></a> * @package Smarty
<a name="line27"></a> */</span>
<a name="line28"></a>&nbsp;
<a name="line29"></a><span style="color: #666666; font-style: italic;">/* $Id: Smarty_Compiler.class.php 2966 2008-12-08 15:10:03Z monte.ohrt $ */</span>
<a name="line30"></a>&nbsp;
<a name="line31"></a><span style="color: #009933; font-style: italic;">/**
<a name="line32"></a> * Template compiling class
<a name="line33"></a> * @package Smarty
<a name="line34"></a> */</span>
<a name="line35"></a><span style="color: #000000; font-weight: bold;">class</span> Smarty_Compiler <span style="color: #000000; font-weight: bold;">extends</span> Smarty <span style="color: #009900;">&#123;</span>
<a name="line36"></a>&nbsp;
<a name="line37"></a>    <span style="color: #666666; font-style: italic;">// internal vars</span>
<a name="line38"></a>    <span style="color: #009933; font-style: italic;">/**#@+
<a name="line39"></a>     * @access private
<a name="line40"></a>     */</span>
<a name="line41"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_folded_blocks</span>         <span style="color: #339933;">=</span>   <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">// keeps folded template blocks</span>
<a name="line42"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_current_file</span>          <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>       <span style="color: #666666; font-style: italic;">// the current template being compiled</span>
<a name="line43"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_current_line_no</span>       <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span>          <span style="color: #666666; font-style: italic;">// line number for error messages</span>
<a name="line44"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_capture_stack</span>         <span style="color: #339933;">=</span>   <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">// keeps track of nested capture buffers</span>
<a name="line45"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_plugin_info</span>           <span style="color: #339933;">=</span>   <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>    <span style="color: #666666; font-style: italic;">// keeps track of plugins to load</span>
<a name="line46"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_init_smarty_vars</span>      <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">false</span><span style="color: #339933;">;</span>
<a name="line47"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_permitted_tokens</span>      <span style="color: #339933;">=</span>   <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'true'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'false'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'yes'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'no'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'on'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'off'</span><span style="color: #339933;">,</span><span style="color: #0000ff;">'null'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line48"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_db_qstr_regexp</span>        <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>        <span style="color: #666666; font-style: italic;">// regexps are setup in the constructor</span>
<a name="line49"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_si_qstr_regexp</span>        <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line50"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_qstr_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line51"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_func_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line52"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_reg_obj_regexp</span>        <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line53"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_var_bracket_regexp</span>    <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line54"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_num_const_regexp</span>      <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line55"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_dvar_guts_regexp</span>      <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line56"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_dvar_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line57"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_cvar_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line58"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_svar_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line59"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_avar_regexp</span>           <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line60"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_mod_regexp</span>            <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line61"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_var_regexp</span>            <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line62"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_parenth_param_regexp</span>  <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line63"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_func_call_regexp</span>      <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line64"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_obj_ext_regexp</span>        <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line65"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_obj_start_regexp</span>      <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line66"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_obj_params_regexp</span>     <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line67"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_obj_call_regexp</span>       <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line68"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_cacheable_state</span>       <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line69"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_cache_attrs_count</span>     <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line70"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_nocache_count</span>         <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line71"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_cache_serial</span>          <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line72"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_cache_include</span>         <span style="color: #339933;">=</span>   <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">;</span>
<a name="line73"></a>&nbsp;
<a name="line74"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_strip_depth</span>           <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line75"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_additional_newline</span>    <span style="color: #339933;">=</span>   <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">;</span>
<a name="line76"></a>&nbsp;
<a name="line77"></a>    <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #000088;">$_phpversion</span>            <span style="color: #339933;">=</span>   <span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span>
<a name="line78"></a>&nbsp;
<a name="line79"></a>&nbsp;
<a name="line80"></a>    <span style="color: #009933; font-style: italic;">/**#@-*/</span>
<a name="line81"></a>    <span style="color: #009933; font-style: italic;">/**
<a name="line82"></a>     * The class constructor.
<a name="line83"></a>     */</span>
<a name="line84"></a>    <span style="color: #000000; font-weight: bold;">function</span> Smarty_Compiler<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
<a name="line85"></a>    <span style="color: #009900;">&#123;</span>
<a name="line86"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_phpversion <span style="color: #339933;">=</span> <a href="http://www.php.net/substr"><span style="color: #990000;">substr</span></a><span style="color: #009900;">&#40;</span><a href="http://www.php.net/phpversion"><span style="color: #990000;">phpversion</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<a name="line87"></a>&nbsp;
<a name="line88"></a>        <span style="color: #666666; font-style: italic;">// matches double quoted strings:</span>
<a name="line89"></a>        <span style="color: #666666; font-style: italic;">// &quot;foobar&quot;</span>
<a name="line90"></a>        <span style="color: #666666; font-style: italic;">// &quot;foo\&quot;bar&quot;</span>
<a name="line91"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_db_qstr_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'&quot;[^&quot;\\\\]*(?:\\\\.[^&quot;\\\\]*)*&quot;'</span><span style="color: #339933;">;</span>
<a name="line92"></a>&nbsp;
<a name="line93"></a>        <span style="color: #666666; font-style: italic;">// matches single quoted strings:</span>
<a name="line94"></a>        <span style="color: #666666; font-style: italic;">// 'foobar'</span>
<a name="line95"></a>        <span style="color: #666666; font-style: italic;">// 'foo\'bar'</span>
<a name="line96"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_si_qstr_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\'[^\'\\\\]*(?:\\\\.[^\'\\\\]*)*\''</span><span style="color: #339933;">;</span>
<a name="line97"></a>&nbsp;
<a name="line98"></a>        <span style="color: #666666; font-style: italic;">// matches single or double quoted strings</span>
<a name="line99"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_qstr_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_db_qstr_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_si_qstr_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
<a name="line100"></a>&nbsp;
<a name="line101"></a>        <span style="color: #666666; font-style: italic;">// matches bracket portion of vars</span>
<a name="line102"></a>        <span style="color: #666666; font-style: italic;">// [0]</span>
<a name="line103"></a>        <span style="color: #666666; font-style: italic;">// [foo]</span>
<a name="line104"></a>        <span style="color: #666666; font-style: italic;">// [$bar]</span>
<a name="line105"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_bracket_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\[\$?[\w\.]+\]'</span><span style="color: #339933;">;</span>
<a name="line106"></a>&nbsp;
<a name="line107"></a>        <span style="color: #666666; font-style: italic;">// matches numerical constants</span>
<a name="line108"></a>        <span style="color: #666666; font-style: italic;">// 30</span>
<a name="line109"></a>        <span style="color: #666666; font-style: italic;">// -12</span>
<a name="line110"></a>        <span style="color: #666666; font-style: italic;">// 13.22</span>
<a name="line111"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:\-?\d+(?:\.\d+)?)'</span><span style="color: #339933;">;</span>
<a name="line112"></a>&nbsp;
<a name="line113"></a>        <span style="color: #666666; font-style: italic;">// matches $ vars (not objects):</span>
<a name="line114"></a>        <span style="color: #666666; font-style: italic;">// $foo</span>
<a name="line115"></a>        <span style="color: #666666; font-style: italic;">// $foo.bar</span>
<a name="line116"></a>        <span style="color: #666666; font-style: italic;">// $foo.bar.foobar</span>
<a name="line117"></a>        <span style="color: #666666; font-style: italic;">// $foo[0]</span>
<a name="line118"></a>        <span style="color: #666666; font-style: italic;">// $foo[$bar]</span>
<a name="line119"></a>        <span style="color: #666666; font-style: italic;">// $foo[5][blah]</span>
<a name="line120"></a>        <span style="color: #666666; font-style: italic;">// $foo[5].bar[$foobar][4]</span>
<a name="line121"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:[\+\*\/\%]|(?:-(?!&gt;)))'</span><span style="color: #339933;">;</span>
<a name="line122"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_var_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'[\$\w\.\+\-\*\/\%\d\&gt;\[\]]'</span><span style="color: #339933;">;</span>
<a name="line123"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_guts_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\w+(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_bracket_regexp
<a name="line124"></a>                <span style="color: #339933;">.</span> <span style="color: #0000ff;">')*(?:\.\$?\w+(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_bracket_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')*)*(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')*)?'</span><span style="color: #339933;">;</span>
<a name="line125"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\$'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_guts_regexp<span style="color: #339933;">;</span>
<a name="line126"></a>&nbsp;
<a name="line127"></a>        <span style="color: #666666; font-style: italic;">// matches config vars:</span>
<a name="line128"></a>        <span style="color: #666666; font-style: italic;">// #foo#</span>
<a name="line129"></a>        <span style="color: #666666; font-style: italic;">// #foobar123_foo#</span>
<a name="line130"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_cvar_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\#\w+\#'</span><span style="color: #339933;">;</span>
<a name="line131"></a>&nbsp;
<a name="line132"></a>        <span style="color: #666666; font-style: italic;">// matches section vars:</span>
<a name="line133"></a>        <span style="color: #666666; font-style: italic;">// %foo.bar%</span>
<a name="line134"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_svar_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\%\w+\.\w+\%'</span><span style="color: #339933;">;</span>
<a name="line135"></a>&nbsp;
<a name="line136"></a>        <span style="color: #666666; font-style: italic;">// matches all valid variables (no quotes, no modifiers)</span>
<a name="line137"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_avar_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span>
<a name="line138"></a>           <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_cvar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_svar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
<a name="line139"></a>&nbsp;
<a name="line140"></a>        <span style="color: #666666; font-style: italic;">// matches valid variable syntax:</span>
<a name="line141"></a>        <span style="color: #666666; font-style: italic;">// $foo</span>
<a name="line142"></a>        <span style="color: #666666; font-style: italic;">// $foo</span>
<a name="line143"></a>        <span style="color: #666666; font-style: italic;">// #foo#</span>
<a name="line144"></a>        <span style="color: #666666; font-style: italic;">// #foo#</span>
<a name="line145"></a>        <span style="color: #666666; font-style: italic;">// &quot;text&quot;</span>
<a name="line146"></a>        <span style="color: #666666; font-style: italic;">// &quot;text&quot;</span>
<a name="line147"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_avar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_qstr_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
<a name="line148"></a>&nbsp;
<a name="line149"></a>        <span style="color: #666666; font-style: italic;">// matches valid object call (one level of object nesting allowed in parameters):</span>
<a name="line150"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar</span>
<a name="line151"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar()</span>
<a name="line152"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar(&quot;text&quot;)</span>
<a name="line153"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar($foo, $bar, &quot;text&quot;)</span>
<a name="line154"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar($foo, &quot;foo&quot;)</span>
<a name="line155"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar-&gt;foo()</span>
<a name="line156"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar-&gt;foo-&gt;bar()</span>
<a name="line157"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar($foo-&gt;bar)</span>
<a name="line158"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar($foo-&gt;bar())</span>
<a name="line159"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar($foo-&gt;bar($blah,$foo,44,&quot;foo&quot;,$foo[0].bar))</span>
<a name="line160"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;getBar()-&gt;getFoo()</span>
<a name="line161"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;getBar()-&gt;foo</span>
<a name="line162"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_ext_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\-&gt;(?:\$?'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_guts_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span><span style="color: #339933;">;</span>
<a name="line163"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_restricted_param_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span>
<a name="line164"></a>             <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_ext_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:\((?:(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')'</span>
<a name="line165"></a>             <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:\s*,\s*(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'))*)?\))?)*)'</span><span style="color: #339933;">;</span>
<a name="line166"></a>&nbsp;
<a name="line167"></a>       <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_single_param_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:\w+|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_restricted_param_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:\s*,\s*(?:(?:\w+|'</span>
<a name="line168"></a>                <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_restricted_param_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')))*)'</span><span style="color: #339933;">;</span>
<a name="line169"></a>&nbsp;
<a name="line170"></a>       <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_params_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'\((?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_single_param_regexp
<a name="line171"></a>                <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:\s*,\s*'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_single_param_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')*)?\)'</span><span style="color: #339933;">;</span>
<a name="line172"></a>       <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_start_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_ext_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')+)'</span><span style="color: #339933;">;</span>
<a name="line173"></a>       <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_call_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_start_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_params_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')?(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_dvar_math_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">')*)?)'</span><span style="color: #339933;">;</span>
<a name="line174"></a>&nbsp;
<a name="line175"></a>        <span style="color: #666666; font-style: italic;">// matches valid modifier syntax:</span>
<a name="line176"></a>        <span style="color: #666666; font-style: italic;">// |foo</span>
<a name="line177"></a>        <span style="color: #666666; font-style: italic;">// |@foo</span>
<a name="line178"></a>        <span style="color: #666666; font-style: italic;">// |foo:&quot;bar&quot;</span>
<a name="line179"></a>        <span style="color: #666666; font-style: italic;">// |foo:$bar</span>
<a name="line180"></a>        <span style="color: #666666; font-style: italic;">// |foo:&quot;bar&quot;:$foobar</span>
<a name="line181"></a>        <span style="color: #666666; font-style: italic;">// |foo|bar</span>
<a name="line182"></a>        <span style="color: #666666; font-style: italic;">// |foo:$foo-&gt;bar</span>
<a name="line183"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_mod_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:\|@?\w+(?::(?:\w+|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span>
<a name="line184"></a>           <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_call_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_avar_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_qstr_regexp <span style="color: #339933;">.</span><span style="color: #0000ff;">'))*)'</span><span style="color: #339933;">;</span>
<a name="line185"></a>&nbsp;
<a name="line186"></a>        <span style="color: #666666; font-style: italic;">// matches valid function name:</span>
<a name="line187"></a>        <span style="color: #666666; font-style: italic;">// foo123</span>
<a name="line188"></a>        <span style="color: #666666; font-style: italic;">// _foo_bar</span>
<a name="line189"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_func_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'[a-zA-Z_]\w*'</span><span style="color: #339933;">;</span>
<a name="line190"></a>&nbsp;
<a name="line191"></a>        <span style="color: #666666; font-style: italic;">// matches valid registered object:</span>
<a name="line192"></a>        <span style="color: #666666; font-style: italic;">// foo-&gt;bar</span>
<a name="line193"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_reg_obj_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'[a-zA-Z_]\w*-&gt;[a-zA-Z_]\w*'</span><span style="color: #339933;">;</span>
<a name="line194"></a>&nbsp;
<a name="line195"></a>        <span style="color: #666666; font-style: italic;">// matches valid parameter values:</span>
<a name="line196"></a>        <span style="color: #666666; font-style: italic;">// true</span>
<a name="line197"></a>        <span style="color: #666666; font-style: italic;">// $foo</span>
<a name="line198"></a>        <span style="color: #666666; font-style: italic;">// $foo|bar</span>
<a name="line199"></a>        <span style="color: #666666; font-style: italic;">// #foo#</span>
<a name="line200"></a>        <span style="color: #666666; font-style: italic;">// #foo#|bar</span>
<a name="line201"></a>        <span style="color: #666666; font-style: italic;">// &quot;text&quot;</span>
<a name="line202"></a>        <span style="color: #666666; font-style: italic;">// &quot;text&quot;|bar</span>
<a name="line203"></a>        <span style="color: #666666; font-style: italic;">// $foo-&gt;bar</span>
<a name="line204"></a>        <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_param_regexp <span style="color: #339933;">=</span> <span style="color: #0000ff;">'(?:\s*(?:'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_obj_call_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span>
<a name="line205"></a>           <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_var_regexp <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|'</span> <span style="color: #339933;">.</span> <span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_num_const_regexp  <span style="color: #339933;">.</span> <span style="color: #0000ff;">'|\w+)(?&gt;</span>' . $this-&gt;_mod_regexp . '*)\s*)';
<a name="line206"></a>&nbsp;
<a name="line207"></a>        // matches valid parenthesised function parameters:
<a name="line208"></a>        //
<a name="line209"></a>        // &quot;text&quot;
<a name="line210"></a>        //    $foo, $bar, &quot;text&quot;
<a name="line211"></a>        // $foo|bar, &quot;foo&quot;|bar, $foo-&gt;bar($foo)|bar
<a name="line212"></a>        $this-&gt;_parenth_param_regexp = '(?:\((?:\w+|'
<a name="line213"></a>                . $this-&gt;_param_regexp . '(?:\s*,\s*(?:(?:\w+|'
<a name="line214"></a>                . $this-&gt;_param_regexp . ')))*)?\))';
<a name="line215"></a>&nbsp;
<a name="line216"></a>        // matches valid function call:
<a name="line217"></a>        // foo()
<a name="line218"></a>        // foo_bar($foo)
<a name="line219"></a>        // _foo_bar($foo,&quot;bar&quot;)
<a name="line220"></a>        // foo123($foo,$foo-&gt;bar(),&quot;foo&quot;)
<a name="line221"></a>        $this-&gt;_func_call_regexp = '(?:' . $this-&gt;_func_regexp . '\s*(?:'
<a name="line222"></a>           . $this-&gt;_parenth_param_regexp . '))';
<a name="line223"></a>    }
<a name="line224"></a>&nbsp;
<a name="line225"></a>    /**
<a name="line226"></a>     * compile a resource
<a name="line227"></a>     *
<a name="line228"></a>     * sets $compiled_content to the compiled source
<a name="line229"></a>     * @param string $resource_name
<a name="line230"></a>     * @param string $source_content
<a name="line231"></a>     * @param string $compiled_content
<a name="line232"></a>     * @return true
<a name="line233"></a>     */
<a name="line234"></a>    function _compile_file($resource_name, $source_content, &amp;$compiled_content)
<a name="line235"></a>    {
<a name="line236"></a>&nbsp;
<a name="line237"></a>        if ($this-&gt;security) {
<a name="line238"></a>            // do not allow php syntax to be executed unless specified
<a name="line239"></a>            if ($this-&gt;php_handling == SMARTY_PHP_ALLOW &amp;&amp;
<a name="line240"></a>                !$this-&gt;security_settings['PHP_HANDLING']) {
<a name="line241"></a>                $this-&gt;php_handling = SMARTY_PHP_PASSTHRU;
<a name="line242"></a>            }
<a name="line243"></a>        }
<a name="line244"></a>&nbsp;
<a name="line245"></a>        $this-&gt;_load_filters();
<a name="line246"></a>&nbsp;
<a name="line247"></a>        $this-&gt;_current_file = $resource_name;
<a name="line248"></a>        $this-&gt;_current_line_no = 1;
<a name="line249"></a>        $ldq = preg_quote($this-&gt;left_delimiter, '~');
<a name="line250"></a>        $rdq = preg_quote($this-&gt;right_delimiter, '~');
<a name="line251"></a>&nbsp;
<a name="line252"></a>        // run template source through prefilter functions
<a name="line253"></a>        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
<a name="line254"></a>            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
<a name="line255"></a>                if ($prefilter === false) continue;
<a name="line256"></a>                if ($prefilter[3] || is_callable($prefilter[0])) {
<a name="line257"></a>                    $source_content = call_user_func_array($prefilter[0],
<a name="line258"></a>                                                            array($source_content, &amp;$this));
<a name="line259"></a>                    $this-&gt;_plugins['prefilter'][$filter_name][3] = true;
<a name="line260"></a>                } else {
<a name="line261"></a>                    $this-&gt;_trigger_fatal_error(&quot;[plugin] prefilter '$filter_name' is not implemented&quot;);
<a name="line262"></a>                }
<a name="line263"></a>            }
<a name="line264"></a>        }
<a name="line265"></a>&nbsp;
<a name="line266"></a>        /* fetch all special blocks */
<a name="line267"></a>        $search = &quot;~{$ldq}\*(.*?)\*{$rdq}|{$ldq}\s*literal\s*{$rdq}(.*?){$ldq}\s*/literal\s*{$rdq}|{$ldq}\s*php\s*{$rdq}(.*?){$ldq}\s*/php\s*{$rdq}~s&quot;;
<a name="line268"></a>&nbsp;
<a name="line269"></a>        preg_match_all($search, $source_content, $match,  PREG_SET_ORDER);
<a name="line270"></a>        $this-&gt;_folded_blocks = $match;
<a name="line271"></a>        reset($this-&gt;_folded_blocks);
<a name="line272"></a>&nbsp;
<a name="line273"></a>        /* replace special blocks by &quot;{php}&quot; */
<a name="line274"></a>        $source_content = preg_replace($search.'e', &quot;'&quot;
<a name="line275"></a>                                       . $this-&gt;_quote_replace($this-&gt;left_delimiter) . 'php'
<a name="line276"></a>                                       . &quot;' . str_repeat(\&quot;\n\&quot;, substr_count('\\0', \&quot;\n\&quot;)) .'&quot;
<a name="line277"></a>                                       . $this-&gt;_quote_replace($this-&gt;right_delimiter)
<a name="line278"></a>                                       . &quot;'&quot;
<a name="line279"></a>                                       , $source_content);
<a name="line280"></a>&nbsp;
<a name="line281"></a>        /* Gather all template tags. */
<a name="line282"></a>        preg_match_all(&quot;~{$ldq}\s*(.*?)\s*{$rdq}~s&quot;, $source_content, $_match);
<a name="line283"></a>        $template_tags = $_match[1];
<a name="line284"></a>        /* Split content by template tags to obtain non-template content. */
<a name="line285"></a>        $text_blocks = preg_split(&quot;~{$ldq}.*?{$rdq}~s&quot;, $source_content);
<a name="line286"></a>&nbsp;
<a name="line287"></a>        /* loop through text blocks */
<a name="line288"></a>        for ($curr_tb = 0, $for_max = count($text_blocks); $curr_tb &lt; $for_max; $curr_tb++) {
<a name="line289"></a>            /* match anything resembling php tags */
<a name="line290"></a>            if (preg_match_all('~(&lt;\?(?:\w+|=)?|\?&gt;|language\s*=\s*[\&quot;\']?\s*php\s*[\&quot;\']?)~is', $text_blocks[$curr_tb], $sp_match)) {
<a name="line291"></a>                /* replace tags with placeholders to prevent recursive replacements */
<a name="line292"></a>                $sp_match[1] = array_unique($sp_match[1]);
<a name="line293"></a>                usort($sp_match[1], '_smarty_sort_length');
<a name="line294"></a>                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
<a name="line295"></a>                    $text_blocks[$curr_tb] = str_replace($sp_match[1][$curr_sp],'%%%SMARTYSP'.$curr_sp.'%%%',$text_blocks[$curr_tb]);
<a name="line296"></a>                }
<a name="line297"></a>                /* process each one */
<a name="line298"></a>                for ($curr_sp = 0, $for_max2 = count($sp_match[1]); $curr_sp &lt; $for_max2; $curr_sp++) {
<a name="line299"></a>                    if ($this-&gt;php_handling == SMARTY_PHP_PASSTHRU) {
<a name="line300"></a>                        /* echo php contents */
<a name="line301"></a>                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> \<span style="color: #0000ff;">''</span><span style="color: #339933;">.</span><a href="http://www.php.net/str_replace"><span style="color: #990000;">str_replace</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;'&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">&quot;\'&quot;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$sp_match</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$curr_sp</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">.</span><span style="color: #0000ff;">'\'; ?&gt;</span>'.&quot;\n&quot;, $text_blocks[$curr_tb]);
<a name="line302"></a>                    } else if ($this-&gt;php_handling == SMARTY_PHP_QUOTE) {
<a name="line303"></a>                        /* quote php tags */
<a name="line304"></a>                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', htmlspecialchars($sp_match[1][$curr_sp]), $text_blocks[$curr_tb]);
<a name="line305"></a>                    } else if ($this-&gt;php_handling == SMARTY_PHP_REMOVE) {
<a name="line306"></a>                        /* remove php tags */
<a name="line307"></a>                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', '', $text_blocks[$curr_tb]);
<a name="line308"></a>                    } else {
<a name="line309"></a>                        /* SMARTY_PHP_ALLOW, but echo non php starting tags */
<a name="line310"></a>                        $sp_match[1][$curr_sp] = preg_replace('~(&lt;\?(?!php|=|$))~i', '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> \<span style="color: #0000ff;">'\\1\'?&gt;</span>'.&quot;\n&quot;, $sp_match[1][$curr_sp]);
<a name="line311"></a>                        $text_blocks[$curr_tb] = str_replace('%%%SMARTYSP'.$curr_sp.'%%%', $sp_match[1][$curr_sp], $text_blocks[$curr_tb]);
<a name="line312"></a>                    }
<a name="line313"></a>                }
<a name="line314"></a>            }
<a name="line315"></a>        }
<a name="line316"></a>&nbsp;
<a name="line317"></a>        /* Compile the template tags into PHP code. */
<a name="line318"></a>        $compiled_tags = array();
<a name="line319"></a>        for ($i = 0, $for_max = count($template_tags); $i &lt; $for_max; $i++) {
<a name="line320"></a>            $this-&gt;_current_line_no += substr_count($text_blocks[$i], &quot;\n&quot;);
<a name="line321"></a>            $compiled_tags[] = $this-&gt;_compile_tag($template_tags[$i]);
<a name="line322"></a>            $this-&gt;_current_line_no += substr_count($template_tags[$i], &quot;\n&quot;);
<a name="line323"></a>        }
<a name="line324"></a>        if (count($this-&gt;_tag_stack)&gt;0) {
<a name="line325"></a>            list($_open_tag, $_line_no) = end($this-&gt;_tag_stack);
<a name="line326"></a>            $this-&gt;_syntax_error(&quot;unclosed tag \{$_open_tag} (opened line $_line_no).&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line327"></a>            return;
<a name="line328"></a>        }
<a name="line329"></a>&nbsp;
<a name="line330"></a>        /* Reformat $text_blocks between 'strip' and '/strip' tags,
<a name="line331"></a>           removing spaces, tabs and newlines. */
<a name="line332"></a>        $strip = false;
<a name="line333"></a>        for ($i = 0, $for_max = count($compiled_tags); $i &lt; $for_max; $i++) {
<a name="line334"></a>            if ($compiled_tags[$i] == '{strip}') {
<a name="line335"></a>                $compiled_tags[$i] = '';
<a name="line336"></a>                $strip = true;
<a name="line337"></a>                /* remove leading whitespaces */
<a name="line338"></a>                $text_blocks[$i + 1] = ltrim($text_blocks[$i + 1]);
<a name="line339"></a>            }
<a name="line340"></a>            if ($strip) {
<a name="line341"></a>                /* strip all $text_blocks before the next '/strip' */
<a name="line342"></a>                for ($j = $i + 1; $j &lt; $for_max; $j++) {
<a name="line343"></a>                    /* remove leading and trailing whitespaces of each line */
<a name="line344"></a>                    $text_blocks[$j] = preg_replace('![\t ]*[\r\n]+[\t ]*!', '', $text_blocks[$j]);
<a name="line345"></a>                    if ($compiled_tags[$j] == '{/strip}') {                       
<a name="line346"></a>                        /* remove trailing whitespaces from the last text_block */
<a name="line347"></a>                        $text_blocks[$j] = rtrim($text_blocks[$j]);
<a name="line348"></a>                    }
<a name="line349"></a>                    $text_blocks[$j] = &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&quot; . strtr($text_blocks[$j], array(&quot;'</span><span style="color: #0000ff;">&quot;=&gt;&quot;</span>\<span style="color: #0000ff;">'&quot;, &quot;\\&quot;=&gt;&quot;\\\\&quot;)) . &quot;'</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line350"></a>                    if ($compiled_tags[$j] == '{/strip}') {
<a name="line351"></a>                        $compiled_tags[$j] = &quot;\n&quot;; /* slurped by php, but necessary
<a name="line352"></a>                                    if a newline is following the closing strip-tag */
<a name="line353"></a>                        $strip = false;
<a name="line354"></a>                        $i = $j;
<a name="line355"></a>                        break;
<a name="line356"></a>                    }
<a name="line357"></a>                }
<a name="line358"></a>            }
<a name="line359"></a>        }
<a name="line360"></a>        $compiled_content = '';
<a name="line361"></a>&nbsp;
<a name="line362"></a>        $tag_guard = '%%%SMARTYOTG' . md5(uniqid(rand(), true)) . '%%%';
<a name="line363"></a>&nbsp;
<a name="line364"></a>        /* Interleave the compiled contents and text blocks to get the final result. */
<a name="line365"></a>        for ($i = 0, $for_max = count($compiled_tags); $i &lt; $for_max; $i++) {
<a name="line366"></a>            if ($compiled_tags[$i] == '') {
<a name="line367"></a>                // tag result empty, remove first newline from following text block
<a name="line368"></a>                $text_blocks[$i+1] = preg_replace('~^(\r\n|\r|\n)~', '', $text_blocks[$i+1]);
<a name="line369"></a>            }
<a name="line370"></a>            // replace legit PHP tags with placeholder
<a name="line371"></a>            $text_blocks[$i] = str_replace('<span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">', $tag_guard, $text_blocks[$i]);
<a name="line372"></a>            $compiled_tags[$i] = str_replace('</span><span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">', $tag_guard, $compiled_tags[$i]);
<a name="line373"></a>&nbsp;
<a name="line374"></a>            $compiled_content .= $text_blocks[$i] . $compiled_tags[$i];
<a name="line375"></a>        }
<a name="line376"></a>        $compiled_content .= str_replace('</span><span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">', $tag_guard, $text_blocks[$i]);
<a name="line377"></a>&nbsp;
<a name="line378"></a>        // escape php tags created by interleaving
<a name="line379"></a>        $compiled_content = str_replace('</span><span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">', &quot;&lt;?php echo '</span><span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">' ?&gt;</span>\n&quot;, $compiled_content);
<a name="line380"></a>        $compiled_content = preg_replace(&quot;~(?&lt;!')language\s*=\s*[\&quot;\']?\s*php\s*[\&quot;\']?~&quot;, &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'language=php'</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>\n&quot;, $compiled_content);
<a name="line381"></a>&nbsp;
<a name="line382"></a>        // recover legit tags
<a name="line383"></a>        $compiled_content = str_replace($tag_guard, '<span style="color: #000000; font-weight: bold;">&lt;?</span><span style="color: #0000ff;">', $compiled_content); 
<a name="line384"></a>&nbsp;
<a name="line385"></a>        // remove \n from the end of the file, if any
<a name="line386"></a>        if (strlen($compiled_content) &amp;&amp; (substr($compiled_content, -1) == &quot;\n&quot;) ) {
<a name="line387"></a>            $compiled_content = substr($compiled_content, 0, -1);
<a name="line388"></a>        }
<a name="line389"></a>&nbsp;
<a name="line390"></a>        if (!empty($this-&gt;_cache_serial)) {
<a name="line391"></a>            $compiled_content = &quot;&lt;?php \$this-&gt;_cache_serials['</span><span style="color: #0000ff;">&quot;.<span style="color: #006699; font-weight: bold;">$this-&gt;_cache_include</span>.&quot;</span><span style="color: #0000ff;">'] = '</span><span style="color: #0000ff;">&quot;.<span style="color: #006699; font-weight: bold;">$this-&gt;_cache_serial</span>.&quot;</span><span style="color: #0000ff;">'; ?&gt;</span>&quot; . $compiled_content;
<a name="line392"></a>        }
<a name="line393"></a>&nbsp;
<a name="line394"></a>        // run compiled template through postfilter functions
<a name="line395"></a>        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
<a name="line396"></a>            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
<a name="line397"></a>                if ($postfilter === false) continue;
<a name="line398"></a>                if ($postfilter[3] || is_callable($postfilter[0])) {
<a name="line399"></a>                    $compiled_content = call_user_func_array($postfilter[0],
<a name="line400"></a>                                                              array($compiled_content, &amp;$this));
<a name="line401"></a>                    $this-&gt;_plugins['postfilter'][$filter_name][3] = true;
<a name="line402"></a>                } else {
<a name="line403"></a>                    $this-&gt;_trigger_fatal_error(&quot;Smarty plugin error: postfilter '$filter_name' is not implemented&quot;);
<a name="line404"></a>                }
<a name="line405"></a>            }
<a name="line406"></a>        }
<a name="line407"></a>&nbsp;
<a name="line408"></a>        // put header at the top of the compiled template
<a name="line409"></a>        $template_header = &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #666666; font-style: italic;">/* Smarty version &quot;.$this-&gt;_version.&quot;, created on &quot;.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;).&quot;\n&quot;;
<a name="line410"></a>        $template_header .= &quot;         compiled from &quot;.strtr(urlencode($resource_name), array('%2F'=&gt;'/', '%3A'=&gt;':')).&quot; */</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>\n&quot;;
<a name="line411"></a>&nbsp;
<a name="line412"></a>        /* Emit code to load needed plugins. */
<a name="line413"></a>        $this-&gt;_plugins_code = '';
<a name="line414"></a>        if (count($this-&gt;_plugin_info)) {
<a name="line415"></a>            $_plugins_params = &quot;array('plugins' =&gt; array(&quot;;
<a name="line416"></a>            foreach ($this-&gt;_plugin_info as $plugin_type =&gt; $plugins) {
<a name="line417"></a>                foreach ($plugins as $plugin_name =&gt; $plugin_info) {
<a name="line418"></a>                    $_plugins_params .= &quot;array('$plugin_type', '$plugin_name', '&quot; . strtr($plugin_info[0], array(&quot;'&quot; =&gt; &quot;\\'&quot;, &quot;\\&quot; =&gt; &quot;\\\\&quot;)) . &quot;', $plugin_info[1], &quot;;
<a name="line419"></a>                    $_plugins_params .= $plugin_info[2] ? 'true),' : 'false),';
<a name="line420"></a>                }
<a name="line421"></a>            }
<a name="line422"></a>            $_plugins_params .= '))';
<a name="line423"></a>            $plugins_code = &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">require_once</span><span style="color: #009900;">&#40;</span>SMARTY_CORE_DIR <span style="color: #339933;">.</span> <span style="color: #0000ff;">'core.load_plugins.php'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>\nsmarty_core_load_plugins<span style="color: #009900;">&#40;</span><span style="color: #000088;">$_plugins_params</span><span style="color: #339933;">,</span> \<span style="color: #000088;">$this</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>\n&quot;;
<a name="line424"></a>            $template_header .= $plugins_code;
<a name="line425"></a>            $this-&gt;_plugin_info = array();
<a name="line426"></a>            $this-&gt;_plugins_code = $plugins_code;
<a name="line427"></a>        }
<a name="line428"></a>&nbsp;
<a name="line429"></a>        if ($this-&gt;_init_smarty_vars) {
<a name="line430"></a>            $template_header .= &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">require_once</span><span style="color: #009900;">&#40;</span>SMARTY_CORE_DIR <span style="color: #339933;">.</span> <span style="color: #0000ff;">'core.assign_smarty_interface.php'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>\nsmarty_core_assign_smarty_interface<span style="color: #009900;">&#40;</span><span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">,</span> \<span style="color: #000088;">$this</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>\n&quot;;
<a name="line431"></a>            $this-&gt;_init_smarty_vars = false;
<a name="line432"></a>        }
<a name="line433"></a>&nbsp;
<a name="line434"></a>        $compiled_content = $template_header . $compiled_content;
<a name="line435"></a>        return true;
<a name="line436"></a>    }
<a name="line437"></a>&nbsp;
<a name="line438"></a>    /**
<a name="line439"></a>     * Compile a template tag
<a name="line440"></a>     *
<a name="line441"></a>     * @param string $template_tag
<a name="line442"></a>     * @return string
<a name="line443"></a>     */
<a name="line444"></a>    function _compile_tag($template_tag)
<a name="line445"></a>    {
<a name="line446"></a>        /* Matched comment. */
<a name="line447"></a>        if (substr($template_tag, 0, 1) == '*' &amp;&amp; substr($template_tag, -1) == '*')
<a name="line448"></a>            return '';
<a name="line449"></a>&nbsp;
<a name="line450"></a>        /* Split tag into two three parts: command, command modifiers and the arguments. */
<a name="line451"></a>        if(! preg_match('~^(?:(' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp
<a name="line452"></a>                . '|\/?' . $this-&gt;_reg_obj_regexp . '|\/?' . $this-&gt;_func_regexp . ')(' . $this-&gt;_mod_regexp . '*))
<a name="line453"></a>                      (?:\s+(.*))?$
<a name="line454"></a>                    ~xs', $template_tag, $match)) {
<a name="line455"></a>            $this-&gt;_syntax_error(&quot;unrecognized tag: $template_tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line456"></a>        }
<a name="line457"></a>&nbsp;
<a name="line458"></a>        $tag_command = $match[1];
<a name="line459"></a>        $tag_modifier = isset($match[2]) ? $match[2] : null;
<a name="line460"></a>        $tag_args = isset($match[3]) ? $match[3] : null;
<a name="line461"></a>&nbsp;
<a name="line462"></a>        if (preg_match('~^' . $this-&gt;_num_const_regexp . '|' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '$~', $tag_command)) {
<a name="line463"></a>            /* tag name is a variable or object */
<a name="line464"></a>            $_return = $this-&gt;_parse_var_props($tag_command . $tag_modifier);
<a name="line465"></a>            return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #000088;">$_return</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; . $this-&gt;_additional_newline;
<a name="line466"></a>        }
<a name="line467"></a>&nbsp;
<a name="line468"></a>        /* If the tag name is a registered object, we process it. */
<a name="line469"></a>        if (preg_match('~^\/?' . $this-&gt;_reg_obj_regexp . '$~', $tag_command)) {
<a name="line470"></a>            return $this-&gt;_compile_registered_object_tag($tag_command, $this-&gt;_parse_attrs($tag_args), $tag_modifier);
<a name="line471"></a>        }
<a name="line472"></a>&nbsp;
<a name="line473"></a>        switch ($tag_command) {
<a name="line474"></a>            case 'include':
<a name="line475"></a>                return $this-&gt;_compile_include_tag($tag_args);
<a name="line476"></a>&nbsp;
<a name="line477"></a>            case 'include_php':
<a name="line478"></a>                return $this-&gt;_compile_include_php_tag($tag_args);
<a name="line479"></a>&nbsp;
<a name="line480"></a>            case 'if':
<a name="line481"></a>                $this-&gt;_push_tag('if');
<a name="line482"></a>                return $this-&gt;_compile_if_tag($tag_args);
<a name="line483"></a>&nbsp;
<a name="line484"></a>            case 'else':
<a name="line485"></a>                list($_open_tag) = end($this-&gt;_tag_stack);
<a name="line486"></a>                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
<a name="line487"></a>                    $this-&gt;_syntax_error('unexpected {else}', E_USER_ERROR, __FILE__, __LINE__);
<a name="line488"></a>                else
<a name="line489"></a>                    $this-&gt;_push_tag('else');
<a name="line490"></a>                return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">else</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line491"></a>&nbsp;
<a name="line492"></a>            case 'elseif':
<a name="line493"></a>                list($_open_tag) = end($this-&gt;_tag_stack);
<a name="line494"></a>                if ($_open_tag != 'if' &amp;&amp; $_open_tag != 'elseif')
<a name="line495"></a>                    $this-&gt;_syntax_error('unexpected {elseif}', E_USER_ERROR, __FILE__, __LINE__);
<a name="line496"></a>                if ($_open_tag == 'if')
<a name="line497"></a>                    $this-&gt;_push_tag('elseif');
<a name="line498"></a>                return $this-&gt;_compile_if_tag($tag_args, true);
<a name="line499"></a>&nbsp;
<a name="line500"></a>            case '/if':
<a name="line501"></a>                $this-&gt;_pop_tag('if');
<a name="line502"></a>                return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line503"></a>&nbsp;
<a name="line504"></a>            case 'capture':
<a name="line505"></a>                return $this-&gt;_compile_capture_tag(true, $tag_args);
<a name="line506"></a>&nbsp;
<a name="line507"></a>            case '/capture':
<a name="line508"></a>                return $this-&gt;_compile_capture_tag(false);
<a name="line509"></a>&nbsp;
<a name="line510"></a>            case 'ldelim':
<a name="line511"></a>                return $this-&gt;left_delimiter;
<a name="line512"></a>&nbsp;
<a name="line513"></a>            case 'rdelim':
<a name="line514"></a>                return $this-&gt;right_delimiter;
<a name="line515"></a>&nbsp;
<a name="line516"></a>            case 'section':
<a name="line517"></a>                $this-&gt;_push_tag('section');
<a name="line518"></a>                return $this-&gt;_compile_section_start($tag_args);
<a name="line519"></a>&nbsp;
<a name="line520"></a>            case 'sectionelse':
<a name="line521"></a>                $this-&gt;_push_tag('sectionelse');
<a name="line522"></a>                return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endfor</span><span style="color: #339933;">;</span> <span style="color: #b1b100;">else</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line523"></a>                break;
<a name="line524"></a>&nbsp;
<a name="line525"></a>            case '/section':
<a name="line526"></a>                $_open_tag = $this-&gt;_pop_tag('section');
<a name="line527"></a>                if ($_open_tag == 'sectionelse')
<a name="line528"></a>                    return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line529"></a>                else
<a name="line530"></a>                    return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endfor</span><span style="color: #339933;">;</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line531"></a>&nbsp;
<a name="line532"></a>            case 'foreach':
<a name="line533"></a>                $this-&gt;_push_tag('foreach');
<a name="line534"></a>                return $this-&gt;_compile_foreach_start($tag_args);
<a name="line535"></a>                break;
<a name="line536"></a>&nbsp;
<a name="line537"></a>            case 'foreachelse':
<a name="line538"></a>                $this-&gt;_push_tag('foreachelse');
<a name="line539"></a>                return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endforeach</span><span style="color: #339933;">;</span> <span style="color: #b1b100;">else</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line540"></a>&nbsp;
<a name="line541"></a>            case '/foreach':
<a name="line542"></a>                $_open_tag = $this-&gt;_pop_tag('foreach');
<a name="line543"></a>                if ($_open_tag == 'foreachelse')
<a name="line544"></a>                    return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <a href="http://www.php.net/unset"><span style="color: #990000;">unset</span></a><span style="color: #009900;">&#40;</span>\<span style="color: #000088;">$_from</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line545"></a>                else
<a name="line546"></a>                    return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">endforeach</span><span style="color: #339933;">;</span> <span style="color: #b1b100;">endif</span><span style="color: #339933;">;</span> <a href="http://www.php.net/unset"><span style="color: #990000;">unset</span></a><span style="color: #009900;">&#40;</span>\<span style="color: #000088;">$_from</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line547"></a>                break;
<a name="line548"></a>&nbsp;
<a name="line549"></a>            case 'strip':
<a name="line550"></a>            case '/strip':
<a name="line551"></a>                if (substr($tag_command, 0, 1)=='/') {
<a name="line552"></a>                    $this-&gt;_pop_tag('strip');
<a name="line553"></a>                    if (--$this-&gt;_strip_depth==0) { /* outermost closing {/strip} */
<a name="line554"></a>                        $this-&gt;_additional_newline = &quot;\n&quot;;
<a name="line555"></a>                        return '{' . $tag_command . '}';
<a name="line556"></a>                    }
<a name="line557"></a>                } else {
<a name="line558"></a>                    $this-&gt;_push_tag('strip');
<a name="line559"></a>                    if ($this-&gt;_strip_depth++==0) { /* outermost opening {strip} */
<a name="line560"></a>                        $this-&gt;_additional_newline = &quot;&quot;;
<a name="line561"></a>                        return '{' . $tag_command . '}';
<a name="line562"></a>                    }
<a name="line563"></a>                }
<a name="line564"></a>                return '';
<a name="line565"></a>&nbsp;
<a name="line566"></a>            case 'php':
<a name="line567"></a>                /* handle folded tags replaced by {php} */
<a name="line568"></a>                list(, $block) = each($this-&gt;_folded_blocks);
<a name="line569"></a>                $this-&gt;_current_line_no += substr_count($block[0], &quot;\n&quot;);
<a name="line570"></a>                /* the number of matched elements in the regexp in _compile_file()
<a name="line571"></a>                   determins the type of folded tag that was found */
<a name="line572"></a>                switch (count($block)) {
<a name="line573"></a>                    case 2: /* comment */
<a name="line574"></a>                        return '';
<a name="line575"></a>&nbsp;
<a name="line576"></a>                    case 3: /* literal */
<a name="line577"></a>                        return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">'&quot; . strtr($block[2], array(&quot;'</span><span style="color: #0000ff;">&quot;=&gt;&quot;</span>\<span style="color: #0000ff;">'&quot;, &quot;\\&quot;=&gt;&quot;\\\\&quot;)) . &quot;'</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; . $this-&gt;_additional_newline;
<a name="line578"></a>&nbsp;
<a name="line579"></a>                    case 4: /* php */
<a name="line580"></a>                        if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['PHP_TAGS']) {
<a name="line581"></a>                            $this-&gt;_syntax_error(&quot;(secure mode) php tags not permitted&quot;, E_USER_WARNING, __FILE__, __LINE__);
<a name="line582"></a>                            return;
<a name="line583"></a>                        }
<a name="line584"></a>                        return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">' . $block[3] .'</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line585"></a>                }
<a name="line586"></a>                break;
<a name="line587"></a>&nbsp;
<a name="line588"></a>            case 'insert':
<a name="line589"></a>                return $this-&gt;_compile_insert_tag($tag_args);
<a name="line590"></a>&nbsp;
<a name="line591"></a>            default:
<a name="line592"></a>                if ($this-&gt;_compile_compiler_tag($tag_command, $tag_args, $output)) {
<a name="line593"></a>                    return $output;
<a name="line594"></a>                } else if ($this-&gt;_compile_block_tag($tag_command, $tag_args, $tag_modifier, $output)) {
<a name="line595"></a>                    return $output;
<a name="line596"></a>                } else if ($this-&gt;_compile_custom_tag($tag_command, $tag_args, $tag_modifier, $output)) {
<a name="line597"></a>                    return $output;                    
<a name="line598"></a>                } else {
<a name="line599"></a>                    $this-&gt;_syntax_error(&quot;unrecognized tag '$tag_command'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line600"></a>                }
<a name="line601"></a>&nbsp;
<a name="line602"></a>        }
<a name="line603"></a>    }
<a name="line604"></a>&nbsp;
<a name="line605"></a>&nbsp;
<a name="line606"></a>    /**
<a name="line607"></a>     * compile the custom compiler tag
<a name="line608"></a>     *
<a name="line609"></a>     * sets $output to the compiled custom compiler tag
<a name="line610"></a>     * @param string $tag_command
<a name="line611"></a>     * @param string $tag_args
<a name="line612"></a>     * @param string $output
<a name="line613"></a>     * @return boolean
<a name="line614"></a>     */
<a name="line615"></a>    function _compile_compiler_tag($tag_command, $tag_args, &amp;$output)
<a name="line616"></a>    {
<a name="line617"></a>        $found = false;
<a name="line618"></a>        $have_function = true;
<a name="line619"></a>&nbsp;
<a name="line620"></a>        /*
<a name="line621"></a>         * First we check if the compiler function has already been registered
<a name="line622"></a>         * or loaded from a plugin file.
<a name="line623"></a>         */
<a name="line624"></a>        if (isset($this-&gt;_plugins['compiler'][$tag_command])) {
<a name="line625"></a>            $found = true;
<a name="line626"></a>            $plugin_func = $this-&gt;_plugins['compiler'][$tag_command][0];
<a name="line627"></a>            if (!is_callable($plugin_func)) {
<a name="line628"></a>                $message = &quot;compiler function '$tag_command' is not implemented&quot;;
<a name="line629"></a>                $have_function = false;
<a name="line630"></a>            }
<a name="line631"></a>        }
<a name="line632"></a>        /*
<a name="line633"></a>         * Otherwise we need to load plugin file and look for the function
<a name="line634"></a>         * inside it.
<a name="line635"></a>         */
<a name="line636"></a>        else if ($plugin_file = $this-&gt;_get_plugin_filepath('compiler', $tag_command)) {
<a name="line637"></a>            $found = true;
<a name="line638"></a>&nbsp;
<a name="line639"></a>            include_once $plugin_file;
<a name="line640"></a>&nbsp;
<a name="line641"></a>            $plugin_func = 'smarty_compiler_' . $tag_command;
<a name="line642"></a>            if (!is_callable($plugin_func)) {
<a name="line643"></a>                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
<a name="line644"></a>                $have_function = false;
<a name="line645"></a>            } else {
<a name="line646"></a>                $this-&gt;_plugins['compiler'][$tag_command] = array($plugin_func, null, null, null, true);
<a name="line647"></a>            }
<a name="line648"></a>        }
<a name="line649"></a>&nbsp;
<a name="line650"></a>        /*
<a name="line651"></a>         * True return value means that we either found a plugin or a
<a name="line652"></a>         * dynamically registered function. False means that we didn't and the
<a name="line653"></a>         * compiler should now emit code to load custom function plugin for this
<a name="line654"></a>         * tag.
<a name="line655"></a>         */
<a name="line656"></a>        if ($found) {
<a name="line657"></a>            if ($have_function) {
<a name="line658"></a>                $output = call_user_func_array($plugin_func, array($tag_args, &amp;$this));
<a name="line659"></a>                if($output != '') {
<a name="line660"></a>                $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">' . $this-&gt;_push_cacheable_state('</span>compiler<span style="color: #0000ff;">', $tag_command)
<a name="line661"></a>                                   . $output
<a name="line662"></a>                                   . $this-&gt;_pop_cacheable_state('</span>compiler<span style="color: #0000ff;">', $tag_command) . '</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line663"></a>                }
<a name="line664"></a>            } else {
<a name="line665"></a>                $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
<a name="line666"></a>            }
<a name="line667"></a>            return true;
<a name="line668"></a>        } else {
<a name="line669"></a>            return false;
<a name="line670"></a>        }
<a name="line671"></a>    }
<a name="line672"></a>&nbsp;
<a name="line673"></a>&nbsp;
<a name="line674"></a>    /**
<a name="line675"></a>     * compile block function tag
<a name="line676"></a>     *
<a name="line677"></a>     * sets $output to compiled block function tag
<a name="line678"></a>     * @param string $tag_command
<a name="line679"></a>     * @param string $tag_args
<a name="line680"></a>     * @param string $tag_modifier
<a name="line681"></a>     * @param string $output
<a name="line682"></a>     * @return boolean
<a name="line683"></a>     */
<a name="line684"></a>    function _compile_block_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
<a name="line685"></a>    {
<a name="line686"></a>        if (substr($tag_command, 0, 1) == '/') {
<a name="line687"></a>            $start_tag = false;
<a name="line688"></a>            $tag_command = substr($tag_command, 1);
<a name="line689"></a>        } else
<a name="line690"></a>            $start_tag = true;
<a name="line691"></a>&nbsp;
<a name="line692"></a>        $found = false;
<a name="line693"></a>        $have_function = true;
<a name="line694"></a>&nbsp;
<a name="line695"></a>        /*
<a name="line696"></a>         * First we check if the block function has already been registered
<a name="line697"></a>         * or loaded from a plugin file.
<a name="line698"></a>         */
<a name="line699"></a>        if (isset($this-&gt;_plugins['block'][$tag_command])) {
<a name="line700"></a>            $found = true;
<a name="line701"></a>            $plugin_func = $this-&gt;_plugins['block'][$tag_command][0];
<a name="line702"></a>            if (!is_callable($plugin_func)) {
<a name="line703"></a>                $message = &quot;block function '$tag_command' is not implemented&quot;;
<a name="line704"></a>                $have_function = false;
<a name="line705"></a>            }
<a name="line706"></a>        }
<a name="line707"></a>        /*
<a name="line708"></a>         * Otherwise we need to load plugin file and look for the function
<a name="line709"></a>         * inside it.
<a name="line710"></a>         */
<a name="line711"></a>        else if ($plugin_file = $this-&gt;_get_plugin_filepath('block', $tag_command)) {
<a name="line712"></a>            $found = true;
<a name="line713"></a>&nbsp;
<a name="line714"></a>            include_once $plugin_file;
<a name="line715"></a>&nbsp;
<a name="line716"></a>            $plugin_func = 'smarty_block_' . $tag_command;
<a name="line717"></a>            if (!function_exists($plugin_func)) {
<a name="line718"></a>                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
<a name="line719"></a>                $have_function = false;
<a name="line720"></a>            } else {
<a name="line721"></a>                $this-&gt;_plugins['block'][$tag_command] = array($plugin_func, null, null, null, true);
<a name="line722"></a>&nbsp;
<a name="line723"></a>            }
<a name="line724"></a>        }
<a name="line725"></a>&nbsp;
<a name="line726"></a>        if (!$found) {
<a name="line727"></a>            return false;
<a name="line728"></a>        } else if (!$have_function) {
<a name="line729"></a>            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
<a name="line730"></a>            return true;
<a name="line731"></a>        }
<a name="line732"></a>&nbsp;
<a name="line733"></a>        /*
<a name="line734"></a>         * Even though we've located the plugin function, compilation
<a name="line735"></a>         * happens only once, so the plugin will still need to be loaded
<a name="line736"></a>         * at runtime for future requests.
<a name="line737"></a>         */
<a name="line738"></a>        $this-&gt;_add_plugin('block', $tag_command);
<a name="line739"></a>&nbsp;
<a name="line740"></a>        if ($start_tag)
<a name="line741"></a>            $this-&gt;_push_tag($tag_command);
<a name="line742"></a>        else
<a name="line743"></a>            $this-&gt;_pop_tag($tag_command);
<a name="line744"></a>&nbsp;
<a name="line745"></a>        if ($start_tag) {
<a name="line746"></a>            $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">' . $this-&gt;_push_cacheable_state('</span>block<span style="color: #0000ff;">', $tag_command);
<a name="line747"></a>            $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line748"></a>            $_cache_attrs='</span><span style="color: #0000ff;">';
<a name="line749"></a>            $arg_list = $this-&gt;_compile_arg_list('</span>block<span style="color: #0000ff;">', $tag_command, $attrs, $_cache_attrs);
<a name="line750"></a>            $output .= &quot;$_cache_attrs\$this-&gt;_tag_stack[] = array('</span><span style="color: #000088;">$tag_command</span><span style="color: #0000ff;">', array(&quot;.implode('</span><span style="color: #339933;">,</span><span style="color: #0000ff;">', $arg_list).'</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #0000ff;">';
<a name="line751"></a>            $output .= '</span><span style="color: #000088;">$_block_repeat</span><span style="color: #339933;">=</span><span style="color: #009900; font-weight: bold;">true</span><span style="color: #339933;">;</span><span style="color: #0000ff;">' . $this-&gt;_compile_plugin_call('</span>block<span style="color: #0000ff;">', $tag_command).'</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_tag_stack<span style="color: #009900;">&#91;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_tag_stack<span style="color: #009900;">&#41;</span><span style="color: #339933;">-</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #009900; font-weight: bold;">null</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">,</span> <span style="color: #000088;">$_block_repeat</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #0000ff;">';
<a name="line752"></a>            $output .= '</span><span style="color: #b1b100;">while</span> <span style="color: #009900;">&#40;</span><span style="color: #000088;">$_block_repeat</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span> <a href="http://www.php.net/ob_start"><span style="color: #990000;">ob_start</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line753"></a>        } else {
<a name="line754"></a>            $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #000088;">$_block_content</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/ob_get_contents"><span style="color: #990000;">ob_get_contents</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <a href="http://www.php.net/ob_end_clean"><span style="color: #990000;">ob_end_clean</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #0000ff;">';
<a name="line755"></a>            $_out_tag_text = $this-&gt;_compile_plugin_call('</span>block<span style="color: #0000ff;">', $tag_command).'</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_tag_stack<span style="color: #009900;">&#91;</span><a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_tag_stack<span style="color: #009900;">&#41;</span><span style="color: #339933;">-</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #000088;">$_block_content</span><span style="color: #339933;">,</span> <span style="color: #000088;">$this</span><span style="color: #339933;">,</span> <span style="color: #000088;">$_block_repeat</span><span style="color: #009900;">&#41;</span><span style="color: #0000ff;">';
<a name="line756"></a>            if ($tag_modifier != '</span><span style="color: #0000ff;">') {
<a name="line757"></a>                $this-&gt;_parse_modifiers($_out_tag_text, $tag_modifier);
<a name="line758"></a>            }
<a name="line759"></a>            $output .= '</span><span style="color: #000088;">$_block_repeat</span><span style="color: #339933;">=</span><span style="color: #009900; font-weight: bold;">false</span><span style="color: #339933;">;</span>echo <span style="color: #0000ff;">' . $_out_tag_text . '</span><span style="color: #339933;">;</span> <span style="color: #009900;">&#125;</span> <span style="color: #0000ff;">';
<a name="line760"></a>            $output .= &quot; array_pop(\$this-&gt;_tag_stack); &quot; . $this-&gt;_pop_cacheable_state('</span>block<span style="color: #0000ff;">', $tag_command) . '</span><span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line761"></a>        }
<a name="line762"></a>&nbsp;
<a name="line763"></a>        return true;
<a name="line764"></a>    }
<a name="line765"></a>&nbsp;
<a name="line766"></a>&nbsp;
<a name="line767"></a>    /**
<a name="line768"></a>     * compile custom function tag
<a name="line769"></a>     *
<a name="line770"></a>     * @param string $tag_command
<a name="line771"></a>     * @param string $tag_args
<a name="line772"></a>     * @param string $tag_modifier
<a name="line773"></a>     * @return string
<a name="line774"></a>     */
<a name="line775"></a>    function _compile_custom_tag($tag_command, $tag_args, $tag_modifier, &amp;$output)
<a name="line776"></a>    {
<a name="line777"></a>        $found = false;
<a name="line778"></a>        $have_function = true;
<a name="line779"></a>&nbsp;
<a name="line780"></a>        /*
<a name="line781"></a>         * First we check if the custom function has already been registered
<a name="line782"></a>         * or loaded from a plugin file.
<a name="line783"></a>         */
<a name="line784"></a>        if (isset($this-&gt;_plugins['function'][$tag_command])) {
<a name="line785"></a>            $found = true;
<a name="line786"></a>            $plugin_func = $this-&gt;_plugins['function'][$tag_command][0];
<a name="line787"></a>            if (!is_callable($plugin_func)) {
<a name="line788"></a>                $message = &quot;custom function '$tag_command' is not implemented&quot;;
<a name="line789"></a>                $have_function = false;
<a name="line790"></a>            }
<a name="line791"></a>        }
<a name="line792"></a>        /*
<a name="line793"></a>         * Otherwise we need to load plugin file and look for the function
<a name="line794"></a>         * inside it.
<a name="line795"></a>         */
<a name="line796"></a>        else if ($plugin_file = $this-&gt;_get_plugin_filepath('function', $tag_command)) {
<a name="line797"></a>            $found = true;
<a name="line798"></a>&nbsp;
<a name="line799"></a>            include_once $plugin_file;
<a name="line800"></a>&nbsp;
<a name="line801"></a>            $plugin_func = 'smarty_function_' . $tag_command;
<a name="line802"></a>            if (!function_exists($plugin_func)) {
<a name="line803"></a>                $message = &quot;plugin function $plugin_func() not found in $plugin_file\n&quot;;
<a name="line804"></a>                $have_function = false;
<a name="line805"></a>            } else {
<a name="line806"></a>                $this-&gt;_plugins['function'][$tag_command] = array($plugin_func, null, null, null, true);
<a name="line807"></a>&nbsp;
<a name="line808"></a>            }
<a name="line809"></a>        }
<a name="line810"></a>&nbsp;
<a name="line811"></a>        if (!$found) {
<a name="line812"></a>            return false;
<a name="line813"></a>        } else if (!$have_function) {
<a name="line814"></a>            $this-&gt;_syntax_error($message, E_USER_WARNING, __FILE__, __LINE__);
<a name="line815"></a>            return true;
<a name="line816"></a>        }
<a name="line817"></a>&nbsp;
<a name="line818"></a>        /* declare plugin to be loaded on display of the template that
<a name="line819"></a>           we compile right now */
<a name="line820"></a>        $this-&gt;_add_plugin('function', $tag_command);
<a name="line821"></a>&nbsp;
<a name="line822"></a>        $_cacheable_state = $this-&gt;_push_cacheable_state('function', $tag_command);
<a name="line823"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line824"></a>        $_cache_attrs = '';
<a name="line825"></a>        $arg_list = $this-&gt;_compile_arg_list('function', $tag_command, $attrs, $_cache_attrs);
<a name="line826"></a>&nbsp;
<a name="line827"></a>        $output = $this-&gt;_compile_plugin_call('function', $tag_command).'(array('.implode(',', $arg_list).&quot;), \$this)&quot;;
<a name="line828"></a>        if($tag_modifier != '') {
<a name="line829"></a>            $this-&gt;_parse_modifiers($output, $tag_modifier);
<a name="line830"></a>        }
<a name="line831"></a>&nbsp;
<a name="line832"></a>        if($output != '') {
<a name="line833"></a>            $output =  '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">' . $_cacheable_state . $_cache_attrs . '</span><span style="color: #b1b100;">echo</span> <span style="color: #0000ff;">' . $output . '</span><span style="color: #339933;">;</span><span style="color: #0000ff;">'
<a name="line834"></a>                . $this-&gt;_pop_cacheable_state('</span><span style="color: #000000; font-weight: bold;">function</span><span style="color: #0000ff;">', $tag_command) . &quot;?&gt;</span>&quot; . $this-&gt;_additional_newline;
<a name="line835"></a>        }
<a name="line836"></a>&nbsp;
<a name="line837"></a>        return true;
<a name="line838"></a>    }
<a name="line839"></a>&nbsp;
<a name="line840"></a>    /**
<a name="line841"></a>     * compile a registered object tag
<a name="line842"></a>     *
<a name="line843"></a>     * @param string $tag_command
<a name="line844"></a>     * @param array $attrs
<a name="line845"></a>     * @param string $tag_modifier
<a name="line846"></a>     * @return string
<a name="line847"></a>     */
<a name="line848"></a>    function _compile_registered_object_tag($tag_command, $attrs, $tag_modifier)
<a name="line849"></a>    {
<a name="line850"></a>        if (substr($tag_command, 0, 1) == '/') {
<a name="line851"></a>            $start_tag = false;
<a name="line852"></a>            $tag_command = substr($tag_command, 1);
<a name="line853"></a>        } else {
<a name="line854"></a>            $start_tag = true;
<a name="line855"></a>        }
<a name="line856"></a>&nbsp;
<a name="line857"></a>        list($object, $obj_comp) = explode('-&gt;', $tag_command);
<a name="line858"></a>&nbsp;
<a name="line859"></a>        $arg_list = array();
<a name="line860"></a>        if(count($attrs)) {
<a name="line861"></a>            $_assign_var = false;
<a name="line862"></a>            foreach ($attrs as $arg_name =&gt; $arg_value) {
<a name="line863"></a>                if($arg_name == 'assign') {
<a name="line864"></a>                    $_assign_var = $arg_value;
<a name="line865"></a>                    unset($attrs['assign']);
<a name="line866"></a>                    continue;
<a name="line867"></a>                }
<a name="line868"></a>                if (is_bool($arg_value))
<a name="line869"></a>                    $arg_value = $arg_value ? 'true' : 'false';
<a name="line870"></a>                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
<a name="line871"></a>            }
<a name="line872"></a>        }
<a name="line873"></a>&nbsp;
<a name="line874"></a>        if($this-&gt;_reg_objects[$object][2]) {
<a name="line875"></a>            // smarty object argument format
<a name="line876"></a>            $args = &quot;array(&quot;.implode(',', (array)$arg_list).&quot;), \$this&quot;;
<a name="line877"></a>        } else {
<a name="line878"></a>            // traditional argument format
<a name="line879"></a>            $args = implode(',', array_values($attrs));
<a name="line880"></a>            if (empty($args)) {
<a name="line881"></a>                $args = '';
<a name="line882"></a>            }
<a name="line883"></a>        }
<a name="line884"></a>&nbsp;
<a name="line885"></a>        $prefix = '';
<a name="line886"></a>        $postfix = '';
<a name="line887"></a>        $newline = '';
<a name="line888"></a>        if(!is_object($this-&gt;_reg_objects[$object][0])) {
<a name="line889"></a>            $this-&gt;_trigger_fatal_error(&quot;registered '$object' is not an object&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
<a name="line890"></a>        } elseif(!empty($this-&gt;_reg_objects[$object][1]) &amp;&amp; !in_array($obj_comp, $this-&gt;_reg_objects[$object][1])) {
<a name="line891"></a>            $this-&gt;_trigger_fatal_error(&quot;'$obj_comp' is not a registered component of object '$object'&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
<a name="line892"></a>        } elseif(method_exists($this-&gt;_reg_objects[$object][0], $obj_comp)) {
<a name="line893"></a>            // method
<a name="line894"></a>            if(in_array($obj_comp, $this-&gt;_reg_objects[$object][3])) {
<a name="line895"></a>                // block method
<a name="line896"></a>                if ($start_tag) {
<a name="line897"></a>                    $prefix = &quot;\$this-&gt;_tag_stack[] = array('$obj_comp', $args); &quot;;
<a name="line898"></a>                    $prefix .= &quot;\$_block_repeat=true; \$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], null, \$this, \$_block_repeat); &quot;;
<a name="line899"></a>                    $prefix .= &quot;while (\$_block_repeat) { ob_start();&quot;;
<a name="line900"></a>                    $return = null;
<a name="line901"></a>                    $postfix = '';
<a name="line902"></a>                } else {
<a name="line903"></a>                    $prefix = &quot;\$_obj_block_content = ob_get_contents(); ob_end_clean(); \$_block_repeat=false;&quot;;
<a name="line904"></a>                    $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp(\$this-&gt;_tag_stack[count(\$this-&gt;_tag_stack)-1][1], \$_obj_block_content, \$this, \$_block_repeat)&quot;;
<a name="line905"></a>                    $postfix = &quot;} array_pop(\$this-&gt;_tag_stack);&quot;;
<a name="line906"></a>                }
<a name="line907"></a>            } else {
<a name="line908"></a>                // non-block method
<a name="line909"></a>                $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp($args)&quot;;
<a name="line910"></a>            }
<a name="line911"></a>        } else {
<a name="line912"></a>            // property
<a name="line913"></a>            $return = &quot;\$this-&gt;_reg_objects['$object'][0]-&gt;$obj_comp&quot;;
<a name="line914"></a>        }
<a name="line915"></a>&nbsp;
<a name="line916"></a>        if($return != null) {
<a name="line917"></a>            if($tag_modifier != '') {
<a name="line918"></a>                $this-&gt;_parse_modifiers($return, $tag_modifier);
<a name="line919"></a>            }
<a name="line920"></a>&nbsp;
<a name="line921"></a>            if(!empty($_assign_var)) {
<a name="line922"></a>                $output = &quot;\$this-&gt;assign('&quot; . $this-&gt;_dequote($_assign_var) .&quot;',  $return);&quot;;
<a name="line923"></a>            } else {
<a name="line924"></a>                $output = 'echo ' . $return . ';';
<a name="line925"></a>                $newline = $this-&gt;_additional_newline;
<a name="line926"></a>            }
<a name="line927"></a>        } else {
<a name="line928"></a>            $output = '';
<a name="line929"></a>        }
<a name="line930"></a>&nbsp;
<a name="line931"></a>        return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">' . $prefix . $output . $postfix . &quot;?&gt;</span>&quot; . $newline;
<a name="line932"></a>    }
<a name="line933"></a>&nbsp;
<a name="line934"></a>    /**
<a name="line935"></a>     * Compile {insert ...} tag
<a name="line936"></a>     *
<a name="line937"></a>     * @param string $tag_args
<a name="line938"></a>     * @return string
<a name="line939"></a>     */
<a name="line940"></a>    function _compile_insert_tag($tag_args)
<a name="line941"></a>    {
<a name="line942"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line943"></a>        $name = $this-&gt;_dequote($attrs['name']);
<a name="line944"></a>&nbsp;
<a name="line945"></a>        if (empty($name)) {
<a name="line946"></a>            return $this-&gt;_syntax_error(&quot;missing insert name&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line947"></a>        }
<a name="line948"></a>&nbsp;
<a name="line949"></a>        if (!preg_match('~^\w+$~', $name)) {
<a name="line950"></a>            return $this-&gt;_syntax_error(&quot;'insert: 'name' must be an insert function name&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line951"></a>        }
<a name="line952"></a>&nbsp;
<a name="line953"></a>        if (!empty($attrs['script'])) {
<a name="line954"></a>            $delayed_loading = true;
<a name="line955"></a>        } else {
<a name="line956"></a>            $delayed_loading = false;
<a name="line957"></a>        }
<a name="line958"></a>&nbsp;
<a name="line959"></a>        foreach ($attrs as $arg_name =&gt; $arg_value) {
<a name="line960"></a>            if (is_bool($arg_value))
<a name="line961"></a>                $arg_value = $arg_value ? 'true' : 'false';
<a name="line962"></a>            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
<a name="line963"></a>        }
<a name="line964"></a>&nbsp;
<a name="line965"></a>        $this-&gt;_add_plugin('insert', $name, $delayed_loading);
<a name="line966"></a>&nbsp;
<a name="line967"></a>        $_params = &quot;array('args' =&gt; array(&quot;.implode(', ', (array)$arg_list).&quot;))&quot;;
<a name="line968"></a>&nbsp;
<a name="line969"></a>        return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">require_once</span><span style="color: #009900;">&#40;</span>SMARTY_CORE_DIR <span style="color: #339933;">.</span> <span style="color: #0000ff;">'core.run_insert_handler.php'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>\necho smarty_core_run_insert_handler<span style="color: #009900;">&#40;</span><span style="color: #000088;">$_params</span><span style="color: #339933;">,</span> \<span style="color: #000088;">$this</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; . $this-&gt;_additional_newline;
<a name="line970"></a>    }
<a name="line971"></a>&nbsp;
<a name="line972"></a>    /**
<a name="line973"></a>     * Compile {include ...} tag
<a name="line974"></a>     *
<a name="line975"></a>     * @param string $tag_args
<a name="line976"></a>     * @return string
<a name="line977"></a>     */
<a name="line978"></a>    function _compile_include_tag($tag_args)
<a name="line979"></a>    {
<a name="line980"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line981"></a>        $arg_list = array();
<a name="line982"></a>&nbsp;
<a name="line983"></a>        if (empty($attrs['file'])) {
<a name="line984"></a>            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line985"></a>        }
<a name="line986"></a>&nbsp;
<a name="line987"></a>        foreach ($attrs as $arg_name =&gt; $arg_value) {
<a name="line988"></a>            if ($arg_name == 'file') {
<a name="line989"></a>                $include_file = $arg_value;
<a name="line990"></a>                continue;
<a name="line991"></a>            } else if ($arg_name == 'assign') {
<a name="line992"></a>                $assign_var = $arg_value;
<a name="line993"></a>                continue;
<a name="line994"></a>            }
<a name="line995"></a>            if (is_bool($arg_value))
<a name="line996"></a>                $arg_value = $arg_value ? 'true' : 'false';
<a name="line997"></a>            $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
<a name="line998"></a>        }
<a name="line999"></a>&nbsp;
<a name="line1000"></a>        $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">';
<a name="line1001"></a>&nbsp;
<a name="line1002"></a>        if (isset($assign_var)) {
<a name="line1003"></a>            $output .= &quot;ob_start();\n&quot;;
<a name="line1004"></a>        }
<a name="line1005"></a>&nbsp;
<a name="line1006"></a>        $output .=
<a name="line1007"></a>            &quot;\$_smarty_tpl_vars = \$this-&gt;_tpl_vars;\n&quot;;
<a name="line1008"></a>&nbsp;
<a name="line1009"></a>&nbsp;
<a name="line1010"></a>        $_params = &quot;array('</span>smarty_include_tpl_file<span style="color: #0000ff;">' =&gt; &quot; . $include_file . &quot;, '</span>smarty_include_vars<span style="color: #0000ff;">' =&gt; array(&quot;.implode('</span><span style="color: #339933;">,</span><span style="color: #0000ff;">', (array)$arg_list).&quot;))&quot;;
<a name="line1011"></a>        $output .= &quot;\$this-&gt;_smarty_include($_params);\n&quot; .
<a name="line1012"></a>        &quot;\$this-&gt;_tpl_vars = \$_smarty_tpl_vars;\n&quot; .
<a name="line1013"></a>        &quot;unset(\$_smarty_tpl_vars);\n&quot;;
<a name="line1014"></a>&nbsp;
<a name="line1015"></a>        if (isset($assign_var)) {
<a name="line1016"></a>            $output .= &quot;\$this-&gt;assign(&quot; . $assign_var . &quot;, ob_get_contents()); ob_end_clean();\n&quot;;
<a name="line1017"></a>        }
<a name="line1018"></a>&nbsp;
<a name="line1019"></a>        $output .= '</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line1020"></a>&nbsp;
<a name="line1021"></a>        return $output;
<a name="line1022"></a>&nbsp;
<a name="line1023"></a>    }
<a name="line1024"></a>&nbsp;
<a name="line1025"></a>    /**
<a name="line1026"></a>     * Compile {include ...} tag
<a name="line1027"></a>     *
<a name="line1028"></a>     * @param string $tag_args
<a name="line1029"></a>     * @return string
<a name="line1030"></a>     */
<a name="line1031"></a>    function _compile_include_php_tag($tag_args)
<a name="line1032"></a>    {
<a name="line1033"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line1034"></a>&nbsp;
<a name="line1035"></a>        if (empty($attrs['file'])) {
<a name="line1036"></a>            $this-&gt;_syntax_error(&quot;missing 'file' attribute in include_php tag&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1037"></a>        }
<a name="line1038"></a>&nbsp;
<a name="line1039"></a>        $assign_var = (empty($attrs['assign'])) ? '' : $this-&gt;_dequote($attrs['assign']);
<a name="line1040"></a>        $once_var = (empty($attrs['once']) || $attrs['once']=='false') ? 'false' : 'true';
<a name="line1041"></a>&nbsp;
<a name="line1042"></a>        $arg_list = array();
<a name="line1043"></a>        foreach($attrs as $arg_name =&gt; $arg_value) {
<a name="line1044"></a>            if($arg_name != 'file' AND $arg_name != 'once' AND $arg_name != 'assign') {
<a name="line1045"></a>                if(is_bool($arg_value))
<a name="line1046"></a>                    $arg_value = $arg_value ? 'true' : 'false';
<a name="line1047"></a>                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
<a name="line1048"></a>            }
<a name="line1049"></a>        }
<a name="line1050"></a>&nbsp;
<a name="line1051"></a>        $_params = &quot;array('smarty_file' =&gt; &quot; . $attrs['file'] . &quot;, 'smarty_assign' =&gt; '$assign_var', 'smarty_once' =&gt; $once_var, 'smarty_include_vars' =&gt; array(&quot;.implode(',', $arg_list).&quot;))&quot;;
<a name="line1052"></a>&nbsp;
<a name="line1053"></a>        return &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">require_once</span><span style="color: #009900;">&#40;</span>SMARTY_CORE_DIR <span style="color: #339933;">.</span> <span style="color: #0000ff;">'core.smarty_include_php.php'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>\nsmarty_core_smarty_include_php<span style="color: #009900;">&#40;</span><span style="color: #000088;">$_params</span><span style="color: #339933;">,</span> \<span style="color: #000088;">$this</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot; . $this-&gt;_additional_newline;
<a name="line1054"></a>    }
<a name="line1055"></a>&nbsp;
<a name="line1056"></a>&nbsp;
<a name="line1057"></a>    /**
<a name="line1058"></a>     * Compile {section ...} tag
<a name="line1059"></a>     *
<a name="line1060"></a>     * @param string $tag_args
<a name="line1061"></a>     * @return string
<a name="line1062"></a>     */
<a name="line1063"></a>    function _compile_section_start($tag_args)
<a name="line1064"></a>    {
<a name="line1065"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line1066"></a>        $arg_list = array();
<a name="line1067"></a>&nbsp;
<a name="line1068"></a>        $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">';
<a name="line1069"></a>        $section_name = $attrs['</span>name<span style="color: #0000ff;">'];
<a name="line1070"></a>        if (empty($section_name)) {
<a name="line1071"></a>            $this-&gt;_syntax_error(&quot;missing section name&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1072"></a>        }
<a name="line1073"></a>&nbsp;
<a name="line1074"></a>        $output .= &quot;unset(\$this-&gt;_sections[$section_name]);\n&quot;;
<a name="line1075"></a>        $section_props = &quot;\$this-&gt;_sections[$section_name]&quot;;
<a name="line1076"></a>&nbsp;
<a name="line1077"></a>        foreach ($attrs as $attr_name =&gt; $attr_value) {
<a name="line1078"></a>            switch ($attr_name) {
<a name="line1079"></a>                case '</span>loop<span style="color: #0000ff;">':
<a name="line1080"></a>                    $output .= &quot;{$section_props}['</span>loop<span style="color: #0000ff;">'] = is_array(\$_loop=$attr_value) ? count(\$_loop) : max(0, (int)\$_loop); unset(\$_loop);\n&quot;;
<a name="line1081"></a>                    break;
<a name="line1082"></a>&nbsp;
<a name="line1083"></a>                case '</span>show<span style="color: #0000ff;">':
<a name="line1084"></a>                    if (is_bool($attr_value))
<a name="line1085"></a>                        $show_attr_value = $attr_value ? '</span><span style="color: #009900; font-weight: bold;">true</span><span style="color: #0000ff;">' : '</span><span style="color: #009900; font-weight: bold;">false</span><span style="color: #0000ff;">';
<a name="line1086"></a>                    else
<a name="line1087"></a>                        $show_attr_value = &quot;(bool)$attr_value&quot;;
<a name="line1088"></a>                    $output .= &quot;{$section_props}['</span>show<span style="color: #0000ff;">'] = $show_attr_value;\n&quot;;
<a name="line1089"></a>                    break;
<a name="line1090"></a>&nbsp;
<a name="line1091"></a>                case '</span>name<span style="color: #0000ff;">':
<a name="line1092"></a>                    $output .= &quot;{$section_props}['</span><span style="color: #000088;">$attr_name</span><span style="color: #0000ff;">'] = $attr_value;\n&quot;;
<a name="line1093"></a>                    break;
<a name="line1094"></a>&nbsp;
<a name="line1095"></a>                case '</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">':
<a name="line1096"></a>                case '</span>start<span style="color: #0000ff;">':
<a name="line1097"></a>                    $output .= &quot;{$section_props}['</span><span style="color: #000088;">$attr_name</span><span style="color: #0000ff;">'] = (int)$attr_value;\n&quot;;
<a name="line1098"></a>                    break;
<a name="line1099"></a>&nbsp;
<a name="line1100"></a>                case '</span>step<span style="color: #0000ff;">':
<a name="line1101"></a>                    $output .= &quot;{$section_props}['</span><span style="color: #000088;">$attr_name</span><span style="color: #0000ff;">'] = ((int)$attr_value) == 0 ? 1 : (int)$attr_value;\n&quot;;
<a name="line1102"></a>                    break;
<a name="line1103"></a>&nbsp;
<a name="line1104"></a>                default:
<a name="line1105"></a>                    $this-&gt;_syntax_error(&quot;unknown section attribute - '</span><span style="color: #000088;">$attr_name</span><span style="color: #0000ff;">'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1106"></a>                    break;
<a name="line1107"></a>            }
<a name="line1108"></a>        }
<a name="line1109"></a>&nbsp;
<a name="line1110"></a>        if (!isset($attrs['</span>show<span style="color: #0000ff;">']))
<a name="line1111"></a>            $output .= &quot;{$section_props}['</span>show<span style="color: #0000ff;">'] = true;\n&quot;;
<a name="line1112"></a>&nbsp;
<a name="line1113"></a>        if (!isset($attrs['</span>loop<span style="color: #0000ff;">']))
<a name="line1114"></a>            $output .= &quot;{$section_props}['</span>loop<span style="color: #0000ff;">'] = 1;\n&quot;;
<a name="line1115"></a>&nbsp;
<a name="line1116"></a>        if (!isset($attrs['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">']))
<a name="line1117"></a>            $output .= &quot;{$section_props}['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">'] = {$section_props}['</span>loop<span style="color: #0000ff;">'];\n&quot;;
<a name="line1118"></a>        else
<a name="line1119"></a>            $output .= &quot;if ({$section_props}['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">'] &lt; 0)\n&quot; .
<a name="line1120"></a>                       &quot;    {$section_props}['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">'] = {$section_props}['</span>loop<span style="color: #0000ff;">'];\n&quot;;
<a name="line1121"></a>&nbsp;
<a name="line1122"></a>        if (!isset($attrs['</span>step<span style="color: #0000ff;">']))
<a name="line1123"></a>            $output .= &quot;{$section_props}['</span>step<span style="color: #0000ff;">'] = 1;\n&quot;;
<a name="line1124"></a>&nbsp;
<a name="line1125"></a>        if (!isset($attrs['</span>start<span style="color: #0000ff;">']))
<a name="line1126"></a>            $output .= &quot;{$section_props}['</span>start<span style="color: #0000ff;">'] = {$section_props}['</span>step<span style="color: #0000ff;">'] &gt; 0 ? 0 : {$section_props}['</span>loop<span style="color: #0000ff;">']-1;\n&quot;;
<a name="line1127"></a>        else {
<a name="line1128"></a>            $output .= &quot;if ({$section_props}['</span>start<span style="color: #0000ff;">'] &lt; 0)\n&quot; .
<a name="line1129"></a>                       &quot;    {$section_props}['</span>start<span style="color: #0000ff;">'] = max({$section_props}['</span>step<span style="color: #0000ff;">'] &gt; 0 ? 0 : -1, {$section_props}['</span>loop<span style="color: #0000ff;">'] + {$section_props}['</span>start<span style="color: #0000ff;">']);\n&quot; .
<a name="line1130"></a>                       &quot;else\n&quot; .
<a name="line1131"></a>                       &quot;    {$section_props}['</span>start<span style="color: #0000ff;">'] = min({$section_props}['</span>start<span style="color: #0000ff;">'], {$section_props}['</span>step<span style="color: #0000ff;">'] &gt; 0 ? {$section_props}['</span>loop<span style="color: #0000ff;">'] : {$section_props}['</span>loop<span style="color: #0000ff;">']-1);\n&quot;;
<a name="line1132"></a>        }
<a name="line1133"></a>&nbsp;
<a name="line1134"></a>        $output .= &quot;if ({$section_props}['</span>show<span style="color: #0000ff;">']) {\n&quot;;
<a name="line1135"></a>        if (!isset($attrs['</span>start<span style="color: #0000ff;">']) &amp;&amp; !isset($attrs['</span>step<span style="color: #0000ff;">']) &amp;&amp; !isset($attrs['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">'])) {
<a name="line1136"></a>            $output .= &quot;    {$section_props}['</span>total<span style="color: #0000ff;">'] = {$section_props}['</span>loop<span style="color: #0000ff;">'];\n&quot;;
<a name="line1137"></a>        } else {
<a name="line1138"></a>            $output .= &quot;    {$section_props}['</span>total<span style="color: #0000ff;">'] = min(ceil(({$section_props}['</span>step<span style="color: #0000ff;">'] &gt; 0 ? {$section_props}['</span>loop<span style="color: #0000ff;">'] - {$section_props}['</span>start<span style="color: #0000ff;">'] : {$section_props}['</span>start<span style="color: #0000ff;">']+1)/abs({$section_props}['</span>step<span style="color: #0000ff;">'])), {$section_props}['</span><a href="http://www.php.net/max"><span style="color: #990000;">max</span></a><span style="color: #0000ff;">']);\n&quot;;
<a name="line1139"></a>        }
<a name="line1140"></a>        $output .= &quot;    if ({$section_props}['</span>total<span style="color: #0000ff;">'] == 0)\n&quot; .
<a name="line1141"></a>                   &quot;        {$section_props}['</span>show<span style="color: #0000ff;">'] = false;\n&quot; .
<a name="line1142"></a>                   &quot;} else\n&quot; .
<a name="line1143"></a>                   &quot;    {$section_props}['</span>total<span style="color: #0000ff;">'] = 0;\n&quot;;
<a name="line1144"></a>&nbsp;
<a name="line1145"></a>        $output .= &quot;if ({$section_props}['</span>show<span style="color: #0000ff;">']):\n&quot;;
<a name="line1146"></a>        $output .= &quot;
<a name="line1147"></a>            for ({$section_props}['</span>index<span style="color: #0000ff;">'] = {$section_props}['</span>start<span style="color: #0000ff;">'], {$section_props}['</span>iteration<span style="color: #0000ff;">'] = 1;
<a name="line1148"></a>                 {$section_props}['</span>iteration<span style="color: #0000ff;">'] &lt;= {$section_props}['</span>total<span style="color: #0000ff;">'];
<a name="line1149"></a>                 {$section_props}['</span>index<span style="color: #0000ff;">'] += {$section_props}['</span>step<span style="color: #0000ff;">'], {$section_props}['</span>iteration<span style="color: #0000ff;">']++):\n&quot;;
<a name="line1150"></a>        $output .= &quot;{$section_props}['</span>rownum<span style="color: #0000ff;">'] = {$section_props}['</span>iteration<span style="color: #0000ff;">'];\n&quot;;
<a name="line1151"></a>        $output .= &quot;{$section_props}['</span>index_prev<span style="color: #0000ff;">'] = {$section_props}['</span>index<span style="color: #0000ff;">'] - {$section_props}['</span>step<span style="color: #0000ff;">'];\n&quot;;
<a name="line1152"></a>        $output .= &quot;{$section_props}['</span>index_next<span style="color: #0000ff;">'] = {$section_props}['</span>index<span style="color: #0000ff;">'] + {$section_props}['</span>step<span style="color: #0000ff;">'];\n&quot;;
<a name="line1153"></a>        $output .= &quot;{$section_props}['</span>first<span style="color: #0000ff;">']      = ({$section_props}['</span>iteration<span style="color: #0000ff;">'] == 1);\n&quot;;
<a name="line1154"></a>        $output .= &quot;{$section_props}['</span>last<span style="color: #0000ff;">']       = ({$section_props}['</span>iteration<span style="color: #0000ff;">'] == {$section_props}['</span>total<span style="color: #0000ff;">']);\n&quot;;
<a name="line1155"></a>&nbsp;
<a name="line1156"></a>        $output .= &quot;?&gt;</span>&quot;;
<a name="line1157"></a>&nbsp;
<a name="line1158"></a>        return $output;
<a name="line1159"></a>    }
<a name="line1160"></a>&nbsp;
<a name="line1161"></a>&nbsp;
<a name="line1162"></a>    /**
<a name="line1163"></a>     * Compile {foreach ...} tag.
<a name="line1164"></a>     *
<a name="line1165"></a>     * @param string $tag_args
<a name="line1166"></a>     * @return string
<a name="line1167"></a>     */
<a name="line1168"></a>    function _compile_foreach_start($tag_args)
<a name="line1169"></a>    {
<a name="line1170"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line1171"></a>        $arg_list = array();
<a name="line1172"></a>&nbsp;
<a name="line1173"></a>        if (empty($attrs['from'])) {
<a name="line1174"></a>            return $this-&gt;_syntax_error(&quot;foreach: missing 'from' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1175"></a>        }
<a name="line1176"></a>        $from = $attrs['from'];
<a name="line1177"></a>&nbsp;
<a name="line1178"></a>        if (empty($attrs['item'])) {
<a name="line1179"></a>            return $this-&gt;_syntax_error(&quot;foreach: missing 'item' attribute&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1180"></a>        }
<a name="line1181"></a>        $item = $this-&gt;_dequote($attrs['item']);
<a name="line1182"></a>        if (!preg_match('~^\w+$~', $item)) {
<a name="line1183"></a>            return $this-&gt;_syntax_error(&quot;foreach: 'item' must be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1184"></a>        }
<a name="line1185"></a>&nbsp;
<a name="line1186"></a>        if (isset($attrs['key'])) {
<a name="line1187"></a>            $key  = $this-&gt;_dequote($attrs['key']);
<a name="line1188"></a>            if (!preg_match('~^\w+$~', $key)) {
<a name="line1189"></a>                return $this-&gt;_syntax_error(&quot;foreach: 'key' must to be a variable name (literal string)&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1190"></a>            }
<a name="line1191"></a>            $key_part = &quot;\$this-&gt;_tpl_vars['$key'] =&gt; &quot;;
<a name="line1192"></a>        } else {
<a name="line1193"></a>            $key = null;
<a name="line1194"></a>            $key_part = '';
<a name="line1195"></a>        }
<a name="line1196"></a>&nbsp;
<a name="line1197"></a>        if (isset($attrs['name'])) {
<a name="line1198"></a>            $name = $attrs['name'];
<a name="line1199"></a>        } else {
<a name="line1200"></a>            $name = null;
<a name="line1201"></a>        }
<a name="line1202"></a>&nbsp;
<a name="line1203"></a>        $output = '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #0000ff;">';
<a name="line1204"></a>        $output .= &quot;\$_from = $from; if (!is_array(\$_from) &amp;&amp; !is_object(\$_from)) { settype(\$_from, '</span><a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #0000ff;">'); }&quot;;
<a name="line1205"></a>        if (isset($name)) {
<a name="line1206"></a>            $foreach_props = &quot;\$this-&gt;_foreach[$name]&quot;;
<a name="line1207"></a>            $output .= &quot;{$foreach_props} = array('</span>total<span style="color: #0000ff;">' =&gt; count(\$_from), '</span>iteration<span style="color: #0000ff;">' =&gt; 0);\n&quot;;
<a name="line1208"></a>            $output .= &quot;if ({$foreach_props}['</span>total<span style="color: #0000ff;">'] &gt; 0):\n&quot;;
<a name="line1209"></a>            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['</span><span style="color: #000088;">$item</span><span style="color: #0000ff;">']):\n&quot;;
<a name="line1210"></a>            $output .= &quot;        {$foreach_props}['</span>iteration<span style="color: #0000ff;">']++;\n&quot;;
<a name="line1211"></a>        } else {
<a name="line1212"></a>            $output .= &quot;if (count(\$_from)):\n&quot;;
<a name="line1213"></a>            $output .= &quot;    foreach (\$_from as $key_part\$this-&gt;_tpl_vars['</span><span style="color: #000088;">$item</span><span style="color: #0000ff;">']):\n&quot;;
<a name="line1214"></a>        }
<a name="line1215"></a>        $output .= '</span><span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line1216"></a>&nbsp;
<a name="line1217"></a>        return $output;
<a name="line1218"></a>    }
<a name="line1219"></a>&nbsp;
<a name="line1220"></a>&nbsp;
<a name="line1221"></a>    /**
<a name="line1222"></a>     * Compile {capture} .. {/capture} tags
<a name="line1223"></a>     *
<a name="line1224"></a>     * @param boolean $start true if this is the {capture} tag
<a name="line1225"></a>     * @param string $tag_args
<a name="line1226"></a>     * @return string
<a name="line1227"></a>     */
<a name="line1228"></a>&nbsp;
<a name="line1229"></a>    function _compile_capture_tag($start, $tag_args = '')
<a name="line1230"></a>    {
<a name="line1231"></a>        $attrs = $this-&gt;_parse_attrs($tag_args);
<a name="line1232"></a>&nbsp;
<a name="line1233"></a>        if ($start) {
<a name="line1234"></a>            $buffer = isset($attrs['name']) ? $attrs['name'] : &quot;'default'&quot;;
<a name="line1235"></a>            $assign = isset($attrs['assign']) ? $attrs['assign'] : null;
<a name="line1236"></a>            $append = isset($attrs['append']) ? $attrs['append'] : null;
<a name="line1237"></a>&nbsp;
<a name="line1238"></a>            $output = &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> <a href="http://www.php.net/ob_start"><span style="color: #990000;">ob_start</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line1239"></a>            $this-&gt;_capture_stack[] = array($buffer, $assign, $append);
<a name="line1240"></a>        } else {
<a name="line1241"></a>            list($buffer, $assign, $append) = array_pop($this-&gt;_capture_stack);
<a name="line1242"></a>            $output = &quot;<span style="color: #000000; font-weight: bold;">&lt;?php</span> \<span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span>_smarty_vars<span style="color: #009900;">&#91;</span><span style="color: #0000ff;">'capture'</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$buffer</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/ob_get_contents"><span style="color: #990000;">ob_get_contents</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #0000ff;">&quot;;
<a name="line1243"></a>            if (isset(<span style="color: #006699; font-weight: bold;">$assign</span>)) {
<a name="line1244"></a>                <span style="color: #006699; font-weight: bold;">$output</span> .= &quot;</span> \<span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">assign</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$assign</span><span style="color: #339933;">,</span> <a href="http://www.php.net/ob_get_contents"><span style="color: #990000;">ob_get_contents</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #0000ff;">&quot;;
<a name="line1245"></a>            }
<a name="line1246"></a>            if (isset(<span style="color: #006699; font-weight: bold;">$append</span>)) {
<a name="line1247"></a>                <span style="color: #006699; font-weight: bold;">$output</span> .= &quot;</span> \<span style="color: #000088;">$this</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">append</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$append</span><span style="color: #339933;">,</span> <a href="http://www.php.net/ob_get_contents"><span style="color: #990000;">ob_get_contents</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #0000ff;">&quot;;
<a name="line1248"></a>            }
<a name="line1249"></a>            <span style="color: #006699; font-weight: bold;">$output</span> .= &quot;</span><a href="http://www.php.net/ob_end_clean"><span style="color: #990000;">ob_end_clean</span></a><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>&quot;;
<a name="line1250"></a>        }
<a name="line1251"></a>&nbsp;
<a name="line1252"></a>        return $output;
<a name="line1253"></a>    }
<a name="line1254"></a>&nbsp;
<a name="line1255"></a>    /**
<a name="line1256"></a>     * Compile {if ...} tag
<a name="line1257"></a>     *
<a name="line1258"></a>     * @param string $tag_args
<a name="line1259"></a>     * @param boolean $elseif if true, uses elseif instead of if
<a name="line1260"></a>     * @return string
<a name="line1261"></a>     */
<a name="line1262"></a>    function _compile_if_tag($tag_args, $elseif = false)
<a name="line1263"></a>    {
<a name="line1264"></a>&nbsp;
<a name="line1265"></a>        /* Tokenize args for 'if' tag. */
<a name="line1266"></a>        preg_match_all('~(?&gt;
<a name="line1267"></a>                ' . $this-&gt;_obj_call_regexp . '(?:' . $this-&gt;_mod_regexp . '*)? | # valid object call
<a name="line1268"></a>                ' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)?    | # var or quoted string
<a name="line1269"></a>                \-?0[xX][0-9a-fA-F]+|\-?\d+(?:\.\d+)?|\.\d+|!==|===|==|!=|&lt;&gt;|&lt;&lt;|&gt;&gt;|&lt;=|&gt;=|\&amp;\&amp;|\|\||\(|\)|,|\!|\^|=|\&amp;|\~|&lt;|&gt;|\||\%|\+|\-|\/|\*|\@    | # valid non-word token
<a name="line1270"></a>                \b\w+\b                                                        | # valid word token
<a name="line1271"></a>                \S+                                                           # anything else
<a name="line1272"></a>                )~x', $tag_args, $match);
<a name="line1273"></a>&nbsp;
<a name="line1274"></a>        $tokens = $match[0];
<a name="line1275"></a>&nbsp;
<a name="line1276"></a>        if(empty($tokens)) {
<a name="line1277"></a>            $_error_msg = $elseif ? &quot;'elseif'&quot; : &quot;'if'&quot;;
<a name="line1278"></a>            $_error_msg .= ' statement requires arguments'; 
<a name="line1279"></a>            $this-&gt;_syntax_error($_error_msg, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1280"></a>        }
<a name="line1281"></a>&nbsp;
<a name="line1282"></a>&nbsp;
<a name="line1283"></a>        // make sure we have balanced parenthesis
<a name="line1284"></a>        $token_count = array_count_values($tokens);
<a name="line1285"></a>        if(isset($token_count['(']) &amp;&amp; $token_count['('] != $token_count[')']) {
<a name="line1286"></a>            $this-&gt;_syntax_error(&quot;unbalanced parenthesis in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1287"></a>        }
<a name="line1288"></a>&nbsp;
<a name="line1289"></a>        $is_arg_stack = array();
<a name="line1290"></a>&nbsp;
<a name="line1291"></a>        for ($i = 0; $i &lt; count($tokens); $i++) {
<a name="line1292"></a>&nbsp;
<a name="line1293"></a>            $token = &amp;$tokens[$i];
<a name="line1294"></a>&nbsp;
<a name="line1295"></a>            switch (strtolower($token)) {
<a name="line1296"></a>                case '!':
<a name="line1297"></a>                case '%':
<a name="line1298"></a>                case '!==':
<a name="line1299"></a>                case '==':
<a name="line1300"></a>                case '===':
<a name="line1301"></a>                case '&gt;':
<a name="line1302"></a>                case '&lt;':
<a name="line1303"></a>                case '!=':
<a name="line1304"></a>                case '&lt;&gt;':
<a name="line1305"></a>                case '&lt;&lt;':
<a name="line1306"></a>                case '&gt;&gt;':
<a name="line1307"></a>                case '&lt;=':
<a name="line1308"></a>                case '&gt;=':
<a name="line1309"></a>                case '&amp;&amp;':
<a name="line1310"></a>                case '||':
<a name="line1311"></a>                case '|':
<a name="line1312"></a>                case '^':
<a name="line1313"></a>                case '&amp;':
<a name="line1314"></a>                case '~':
<a name="line1315"></a>                case ')':
<a name="line1316"></a>                case ',':
<a name="line1317"></a>                case '+':
<a name="line1318"></a>                case '-':
<a name="line1319"></a>                case '*':
<a name="line1320"></a>                case '/':
<a name="line1321"></a>                case '@':
<a name="line1322"></a>                    break;
<a name="line1323"></a>&nbsp;
<a name="line1324"></a>                case 'eq':
<a name="line1325"></a>                    $token = '==';
<a name="line1326"></a>                    break;
<a name="line1327"></a>&nbsp;
<a name="line1328"></a>                case 'ne':
<a name="line1329"></a>                case 'neq':
<a name="line1330"></a>                    $token = '!=';
<a name="line1331"></a>                    break;
<a name="line1332"></a>&nbsp;
<a name="line1333"></a>                case 'lt':
<a name="line1334"></a>                    $token = '&lt;';
<a name="line1335"></a>                    break;
<a name="line1336"></a>&nbsp;
<a name="line1337"></a>                case 'le':
<a name="line1338"></a>                case 'lte':
<a name="line1339"></a>                    $token = '&lt;=';
<a name="line1340"></a>                    break;
<a name="line1341"></a>&nbsp;
<a name="line1342"></a>                case 'gt':
<a name="line1343"></a>                    $token = '&gt;';
<a name="line1344"></a>                    break;
<a name="line1345"></a>&nbsp;
<a name="line1346"></a>                case 'ge':
<a name="line1347"></a>                case 'gte':
<a name="line1348"></a>                    $token = '&gt;=';
<a name="line1349"></a>                    break;
<a name="line1350"></a>&nbsp;
<a name="line1351"></a>                case 'and':
<a name="line1352"></a>                    $token = '&amp;&amp;';
<a name="line1353"></a>                    break;
<a name="line1354"></a>&nbsp;
<a name="line1355"></a>                case 'or':
<a name="line1356"></a>                    $token = '||';
<a name="line1357"></a>                    break;
<a name="line1358"></a>&nbsp;
<a name="line1359"></a>                case 'not':
<a name="line1360"></a>                    $token = '!';
<a name="line1361"></a>                    break;
<a name="line1362"></a>&nbsp;
<a name="line1363"></a>                case 'mod':
<a name="line1364"></a>                    $token = '%';
<a name="line1365"></a>                    break;
<a name="line1366"></a>&nbsp;
<a name="line1367"></a>                case '(':
<a name="line1368"></a>                    array_push($is_arg_stack, $i);
<a name="line1369"></a>                    break;
<a name="line1370"></a>&nbsp;
<a name="line1371"></a>                case 'is':
<a name="line1372"></a>                    /* If last token was a ')', we operate on the parenthesized
<a name="line1373"></a>                       expression. The start of the expression is on the stack.
<a name="line1374"></a>                       Otherwise, we operate on the last encountered token. */
<a name="line1375"></a>                    if ($tokens[$i-1] == ')') {
<a name="line1376"></a>                        $is_arg_start = array_pop($is_arg_stack);
<a name="line1377"></a>                        if ($is_arg_start != 0) {
<a name="line1378"></a>                            if (preg_match('~^' . $this-&gt;_func_regexp . '$~', $tokens[$is_arg_start-1])) {
<a name="line1379"></a>                                $is_arg_start--;
<a name="line1380"></a>                            } 
<a name="line1381"></a>                        } 
<a name="line1382"></a>                    } else
<a name="line1383"></a>                        $is_arg_start = $i-1;
<a name="line1384"></a>                    /* Construct the argument for 'is' expression, so it knows
<a name="line1385"></a>                       what to operate on. */
<a name="line1386"></a>                    $is_arg = implode(' ', array_slice($tokens, $is_arg_start, $i - $is_arg_start));
<a name="line1387"></a>&nbsp;
<a name="line1388"></a>                    /* Pass all tokens from next one until the end to the
<a name="line1389"></a>                       'is' expression parsing function. The function will
<a name="line1390"></a>                       return modified tokens, where the first one is the result
<a name="line1391"></a>                       of the 'is' expression and the rest are the tokens it
<a name="line1392"></a>                       didn't touch. */
<a name="line1393"></a>                    $new_tokens = $this-&gt;_parse_is_expr($is_arg, array_slice($tokens, $i+1));
<a name="line1394"></a>&nbsp;
<a name="line1395"></a>                    /* Replace the old tokens with the new ones. */
<a name="line1396"></a>                    array_splice($tokens, $is_arg_start, count($tokens), $new_tokens);
<a name="line1397"></a>&nbsp;
<a name="line1398"></a>                    /* Adjust argument start so that it won't change from the
<a name="line1399"></a>                       current position for the next iteration. */
<a name="line1400"></a>                    $i = $is_arg_start;
<a name="line1401"></a>                    break;
<a name="line1402"></a>&nbsp;
<a name="line1403"></a>                default:
<a name="line1404"></a>                    if(preg_match('~^' . $this-&gt;_func_regexp . '$~', $token) ) {
<a name="line1405"></a>                            // function call
<a name="line1406"></a>                            if($this-&gt;security &amp;&amp;
<a name="line1407"></a>                               !in_array($token, $this-&gt;security_settings['IF_FUNCS'])) {
<a name="line1408"></a>                                $this-&gt;_syntax_error(&quot;(secure mode) '$token' not allowed in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1409"></a>                            }
<a name="line1410"></a>                    } elseif(preg_match('~^' . $this-&gt;_var_regexp . '$~', $token) &amp;&amp; (strpos('+-*/^%&amp;|', substr($token, -1)) === false) &amp;&amp; isset($tokens[$i+1]) &amp;&amp; $tokens[$i+1] == '(') {
<a name="line1411"></a>                        // variable function call
<a name="line1412"></a>                        $this-&gt;_syntax_error(&quot;variable function call '$token' not allowed in if statement&quot;, E_USER_ERROR, __FILE__, __LINE__);                      
<a name="line1413"></a>                    } elseif(preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $token)) {
<a name="line1414"></a>                        // object or variable
<a name="line1415"></a>                        $token = $this-&gt;_parse_var_props($token);
<a name="line1416"></a>                    } elseif(is_numeric($token)) {
<a name="line1417"></a>                        // number, skip it
<a name="line1418"></a>                    } else {
<a name="line1419"></a>                        $this-&gt;_syntax_error(&quot;unidentified token '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1420"></a>                    }
<a name="line1421"></a>                    break;
<a name="line1422"></a>            }
<a name="line1423"></a>        }
<a name="line1424"></a>&nbsp;
<a name="line1425"></a>        if ($elseif)
<a name="line1426"></a>            return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">elseif</span> <span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'.implode('</span> <span style="color: #0000ff;">', $tokens).'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line1427"></a>        else
<a name="line1428"></a>            return '<span style="color: #000000; font-weight: bold;">&lt;?php</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #0000ff;">'.implode('</span> <span style="color: #0000ff;">', $tokens).'</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">:</span> <span style="color: #000000; font-weight: bold;">?&gt;</span>';
<a name="line1429"></a>    }
<a name="line1430"></a>&nbsp;
<a name="line1431"></a>&nbsp;
<a name="line1432"></a>    function _compile_arg_list($type, $name, $attrs, &amp;$cache_code) {
<a name="line1433"></a>        $arg_list = array();
<a name="line1434"></a>&nbsp;
<a name="line1435"></a>        if (isset($type) &amp;&amp; isset($name)
<a name="line1436"></a>            &amp;&amp; isset($this-&gt;_plugins[$type])
<a name="line1437"></a>            &amp;&amp; isset($this-&gt;_plugins[$type][$name])
<a name="line1438"></a>            &amp;&amp; empty($this-&gt;_plugins[$type][$name][4])
<a name="line1439"></a>            &amp;&amp; is_array($this-&gt;_plugins[$type][$name][5])
<a name="line1440"></a>            ) {
<a name="line1441"></a>            /* we have a list of parameters that should be cached */
<a name="line1442"></a>            $_cache_attrs = $this-&gt;_plugins[$type][$name][5];
<a name="line1443"></a>            $_count = $this-&gt;_cache_attrs_count++;
<a name="line1444"></a>            $cache_code = &quot;\$_cache_attrs =&amp; \$this-&gt;_smarty_cache_attrs('$this-&gt;_cache_serial','$_count');&quot;;
<a name="line1445"></a>&nbsp;
<a name="line1446"></a>        } else {
<a name="line1447"></a>            /* no parameters are cached */
<a name="line1448"></a>            $_cache_attrs = null;
<a name="line1449"></a>        }
<a name="line1450"></a>&nbsp;
<a name="line1451"></a>        foreach ($attrs as $arg_name =&gt; $arg_value) {
<a name="line1452"></a>            if (is_bool($arg_value))
<a name="line1453"></a>                $arg_value = $arg_value ? 'true' : 'false';
<a name="line1454"></a>            if (is_null($arg_value))
<a name="line1455"></a>                $arg_value = 'null';
<a name="line1456"></a>            if ($_cache_attrs &amp;&amp; in_array($arg_name, $_cache_attrs)) {
<a name="line1457"></a>                $arg_list[] = &quot;'$arg_name' =&gt; (\$this-&gt;_cache_including) ? \$_cache_attrs['$arg_name'] : (\$_cache_attrs['$arg_name']=$arg_value)&quot;;
<a name="line1458"></a>            } else {
<a name="line1459"></a>                $arg_list[] = &quot;'$arg_name' =&gt; $arg_value&quot;;
<a name="line1460"></a>            }
<a name="line1461"></a>        }
<a name="line1462"></a>        return $arg_list;
<a name="line1463"></a>    }
<a name="line1464"></a>&nbsp;
<a name="line1465"></a>    /**
<a name="line1466"></a>     * Parse is expression
<a name="line1467"></a>     *
<a name="line1468"></a>     * @param string $is_arg
<a name="line1469"></a>     * @param array $tokens
<a name="line1470"></a>     * @return array
<a name="line1471"></a>     */
<a name="line1472"></a>    function _parse_is_expr($is_arg, $tokens)
<a name="line1473"></a>    {
<a name="line1474"></a>        $expr_end = 0;
<a name="line1475"></a>        $negate_expr = false;
<a name="line1476"></a>&nbsp;
<a name="line1477"></a>        if (($first_token = array_shift($tokens)) == 'not') {
<a name="line1478"></a>            $negate_expr = true;
<a name="line1479"></a>            $expr_type = array_shift($tokens);
<a name="line1480"></a>        } else
<a name="line1481"></a>            $expr_type = $first_token;
<a name="line1482"></a>&nbsp;
<a name="line1483"></a>        switch ($expr_type) {
<a name="line1484"></a>            case 'even':
<a name="line1485"></a>                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
<a name="line1486"></a>                    $expr_end++;
<a name="line1487"></a>                    $expr_arg = $tokens[$expr_end++];
<a name="line1488"></a>                    $expr = &quot;!(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
<a name="line1489"></a>                } else
<a name="line1490"></a>                    $expr = &quot;!(1 &amp; $is_arg)&quot;;
<a name="line1491"></a>                break;
<a name="line1492"></a>&nbsp;
<a name="line1493"></a>            case 'odd':
<a name="line1494"></a>                if (isset($tokens[$expr_end]) &amp;&amp; $tokens[$expr_end] == 'by') {
<a name="line1495"></a>                    $expr_end++;
<a name="line1496"></a>                    $expr_arg = $tokens[$expr_end++];
<a name="line1497"></a>                    $expr = &quot;(1 &amp; ($is_arg / &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;))&quot;;
<a name="line1498"></a>                } else
<a name="line1499"></a>                    $expr = &quot;(1 &amp; $is_arg)&quot;;
<a name="line1500"></a>                break;
<a name="line1501"></a>&nbsp;
<a name="line1502"></a>            case 'div':
<a name="line1503"></a>                if (@$tokens[$expr_end] == 'by') {
<a name="line1504"></a>                    $expr_end++;
<a name="line1505"></a>                    $expr_arg = $tokens[$expr_end++];
<a name="line1506"></a>                    $expr = &quot;!($is_arg % &quot; . $this-&gt;_parse_var_props($expr_arg) . &quot;)&quot;;
<a name="line1507"></a>                } else {
<a name="line1508"></a>                    $this-&gt;_syntax_error(&quot;expecting 'by' after 'div'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1509"></a>                }
<a name="line1510"></a>                break;
<a name="line1511"></a>&nbsp;
<a name="line1512"></a>            default:
<a name="line1513"></a>                $this-&gt;_syntax_error(&quot;unknown 'is' expression - '$expr_type'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1514"></a>                break;
<a name="line1515"></a>        }
<a name="line1516"></a>&nbsp;
<a name="line1517"></a>        if ($negate_expr) {
<a name="line1518"></a>            $expr = &quot;!($expr)&quot;;
<a name="line1519"></a>        }
<a name="line1520"></a>&nbsp;
<a name="line1521"></a>        array_splice($tokens, 0, $expr_end, $expr);
<a name="line1522"></a>&nbsp;
<a name="line1523"></a>        return $tokens;
<a name="line1524"></a>    }
<a name="line1525"></a>&nbsp;
<a name="line1526"></a>&nbsp;
<a name="line1527"></a>    /**
<a name="line1528"></a>     * Parse attribute string
<a name="line1529"></a>     *
<a name="line1530"></a>     * @param string $tag_args
<a name="line1531"></a>     * @return array
<a name="line1532"></a>     */
<a name="line1533"></a>    function _parse_attrs($tag_args)
<a name="line1534"></a>    {
<a name="line1535"></a>&nbsp;
<a name="line1536"></a>        /* Tokenize tag attributes. */
<a name="line1537"></a>        preg_match_all('~(?:' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_qstr_regexp . ' | (?&gt;[^&quot;\'=\s]+)
<a name="line1538"></a>                         )+ |
<a name="line1539"></a>                         [=]
<a name="line1540"></a>                        ~x', $tag_args, $match);
<a name="line1541"></a>        $tokens       = $match[0];
<a name="line1542"></a>&nbsp;
<a name="line1543"></a>        $attrs = array();
<a name="line1544"></a>        /* Parse state:
<a name="line1545"></a>            0 - expecting attribute name
<a name="line1546"></a>            1 - expecting '='
<a name="line1547"></a>            2 - expecting attribute value (not '=') */
<a name="line1548"></a>        $state = 0;
<a name="line1549"></a>&nbsp;
<a name="line1550"></a>        foreach ($tokens as $token) {
<a name="line1551"></a>            switch ($state) {
<a name="line1552"></a>                case 0:
<a name="line1553"></a>                    /* If the token is a valid identifier, we set attribute name
<a name="line1554"></a>                       and go to state 1. */
<a name="line1555"></a>                    if (preg_match('~^\w+$~', $token)) {
<a name="line1556"></a>                        $attr_name = $token;
<a name="line1557"></a>                        $state = 1;
<a name="line1558"></a>                    } else
<a name="line1559"></a>                        $this-&gt;_syntax_error(&quot;invalid attribute name: '$token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1560"></a>                    break;
<a name="line1561"></a>&nbsp;
<a name="line1562"></a>                case 1:
<a name="line1563"></a>                    /* If the token is '=', then we go to state 2. */
<a name="line1564"></a>                    if ($token == '=') {
<a name="line1565"></a>                        $state = 2;
<a name="line1566"></a>                    } else
<a name="line1567"></a>                        $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1568"></a>                    break;
<a name="line1569"></a>&nbsp;
<a name="line1570"></a>                case 2:
<a name="line1571"></a>                    /* If token is not '=', we set the attribute value and go to
<a name="line1572"></a>                       state 0. */
<a name="line1573"></a>                    if ($token != '=') {
<a name="line1574"></a>                        /* We booleanize the token if it's a non-quoted possible
<a name="line1575"></a>                           boolean value. */
<a name="line1576"></a>                        if (preg_match('~^(on|yes|true)$~', $token)) {
<a name="line1577"></a>                            $token = 'true';
<a name="line1578"></a>                        } else if (preg_match('~^(off|no|false)$~', $token)) {
<a name="line1579"></a>                            $token = 'false';
<a name="line1580"></a>                        } else if ($token == 'null') {
<a name="line1581"></a>                            $token = 'null';
<a name="line1582"></a>                        } else if (preg_match('~^' . $this-&gt;_num_const_regexp . '|0[xX][0-9a-fA-F]+$~', $token)) {
<a name="line1583"></a>                            /* treat integer literally */
<a name="line1584"></a>                        } else if (!preg_match('~^' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_var_regexp . '(?:' . $this-&gt;_mod_regexp . ')*$~', $token)) {
<a name="line1585"></a>                            /* treat as a string, double-quote it escaping quotes */
<a name="line1586"></a>                            $token = '&quot;'.addslashes($token).'&quot;';
<a name="line1587"></a>                        }
<a name="line1588"></a>&nbsp;
<a name="line1589"></a>                        $attrs[$attr_name] = $token;
<a name="line1590"></a>                        $state = 0;
<a name="line1591"></a>                    } else
<a name="line1592"></a>                        $this-&gt;_syntax_error(&quot;'=' cannot be an attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1593"></a>                    break;
<a name="line1594"></a>            }
<a name="line1595"></a>            $last_token = $token;
<a name="line1596"></a>        }
<a name="line1597"></a>&nbsp;
<a name="line1598"></a>        if($state != 0) {
<a name="line1599"></a>            if($state == 1) {
<a name="line1600"></a>                $this-&gt;_syntax_error(&quot;expecting '=' after attribute name '$last_token'&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1601"></a>            } else {
<a name="line1602"></a>                $this-&gt;_syntax_error(&quot;missing attribute value&quot;, E_USER_ERROR, __FILE__, __LINE__);
<a name="line1603"></a>            }
<a name="line1604"></a>        }
<a name="line1605"></a>&nbsp;
<a name="line1606"></a>        $this-&gt;_parse_vars_props($attrs);
<a name="line1607"></a>&nbsp;
<a name="line1608"></a>        return $attrs;
<a name="line1609"></a>    }
<a name="line1610"></a>&nbsp;
<a name="line1611"></a>    /**
<a name="line1612"></a>     * compile multiple variables and section properties tokens into
<a name="line1613"></a>     * PHP code
<a name="line1614"></a>     *
<a name="line1615"></a>     * @param array $tokens
<a name="line1616"></a>     */
<a name="line1617"></a>    function _parse_vars_props(&amp;$tokens)
<a name="line1618"></a>    {
<a name="line1619"></a>        foreach($tokens as $key =&gt; $val) {
<a name="line1620"></a>            $tokens[$key] = $this-&gt;_parse_var_props($val);
<a name="line1621"></a>        }
<a name="line1622"></a>    }
<a name="line1623"></a>&nbsp;
<a name="line1624"></a>    /**
<a name="line1625"></a>     * compile single variable and section properties token into
<a name="line1626"></a>     * PHP code
<a name="line1627"></a>     *
<a name="line1628"></a>     * @param string $val
<a name="line1629"></a>     * @param string $tag_attrs
<a name="line1630"></a>     * @return string
<a name="line1631"></a>     */
<a name="line1632"></a>    function _parse_var_props($val)
<a name="line1633"></a>    {
<a name="line1634"></a>        $val = trim($val);
<a name="line1635"></a>&nbsp;
<a name="line1636"></a>        if(preg_match('~^(' . $this-&gt;_obj_call_regexp . '|' . $this-&gt;_dvar_regexp . ')(' . $this-&gt;_mod_regexp . '*)$~', $val, $match)) {
<a name="line1637"></a>            // $ variable or object
<a name="line1638"></a>            $return = $this-&gt;_parse_var($match[1]);
<a name="line1639"></a>            $modifiers = $match[2];
<a name="line1640"></a>            if (!empty($this-&gt;default_modifiers) &amp;&amp; !preg_match('~(^|\|)smarty:nodefaults($|\|)~',$modifiers)) {
<a name="line1641"></a>                $_default_mod_string = implode('|',(array)$this-&gt;default_modifiers);
<a name="line1642"></a>                $modifiers = empty($modifiers) ? $_default_mod_string : $_default_mod_string . '|' . $modifiers;
<a name="line1643"></a>            }
<a name="line1644"></a>            $this-&gt;_parse_modifiers($return, $modifiers);
<a name="line1645"></a>            return $return;
<a name="line1646"></a>        } elseif (preg_match('~^' . $this-&gt;_db_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
<a name="line1647"></a>                // double quoted text
<a name="line1648"></a>                preg_match('~^(' . $this-&gt;_db_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
<a name="line1649"></a>                $return = $this-&gt;_expand_quoted_text($match[1]);
<a name="line1650"></a>                if($match[2] != '') {
<a name="line1651"></a>                    $this-&gt;_parse_modifiers($return, $match[2]);
<a name="line1652"></a>                }
<a name="line1653"></a>                return $return;
<a name="line1654"></a>            }
<a name="line1655"></a>        elseif(preg_match('~^' . $this-&gt;_num_const_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
<a name="line1656"></a>                // numerical constant
<a name="line1657"></a>                preg_match('~^(' . $this-&gt;_num_const_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
<a name="line1658"></a>                if($match[2] != '') {
<a name="line1659"></a>                    $this-&gt;_parse_modifiers($match[1], $match[2]);
<a name="line1660"></a>                    return $match[1];
<a name="line1661"></a>                }
<a name="line1662"></a>            }
<a name="line1663"></a>        elseif(preg_match('~^' . $this-&gt;_si_qstr_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
<a name="line1664"></a>                // single quoted text
<a name="line1665"></a>                preg_match('~^(' . $this-&gt;_si_qstr_regexp . ')('. $this-&gt;_mod_regexp . '*)$~', $val, $match);
<a name="line1666"></a>                if($match[2] != '') {
<a name="line1667"></a>                    $this-&gt;_parse_modifiers($match[1], $match[2]);
<a name="line1668"></a>                    return $match[1];
<a name="line1669"></a>                }
<a name="line1670"></a>            }
<a name="line1671"></a>        elseif(preg_match('~^' . $this-&gt;_cvar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
<a name="line1672"></a>                // config var
<a name="line1673"></a>                return $this-&gt;_parse_conf_var($val);
<a name="line1674"></a>            }
<a name="line1675"></a>        elseif(preg_match('~^' . $this-&gt;_svar_regexp . '(?:' . $this-&gt;_mod_regexp . '*)$~', $val)) {
<a name="line1676"></a>                // section var
<a name="line1677"></a>                return $this-&gt;_parse_section_prop($val);
<a name="line1678"></a>            }
<a name="line1679"></a>        elseif(!in_array($val, $this-&gt;_permitted_tokens) &amp;&amp; !is_numeric($val)) {
<a name="line1680"></a>            // literal string
<a name="line1681"></a>            return $this-&gt;_expand_quoted_text('&quot;' . strtr($val, array('\\' =&gt; '\\\\', '&quot;' =&gt; '\\&quot;')) .'&quot;');
<a name="line1682"></a>        }
<a name="line1683"></a>        return $val;
<a name="line1684"></a>    }
<a name="line1685"></a>&nbsp;
<a name="line1686"></a>    /**
<a name="line1687"></a>     * expand quoted text with embedded variables
<a name="line1688"></a>     *
<a name="line1689"></a>     * @param string $var_expr
<a name="line1690"></a>     * @return string
<a name="line1691"></a>     */
<a name="line1692"></a>    function _expand_quoted_text($var_expr)
<a name="line1693"></a>    {
<a name="line1694"></a>        // if contains unescaped $, expand it
<a name="line1695"></a>        if(preg_match_all('~(?:\`(?&lt;!\\\\)\$' . $this-&gt;_dvar_guts_regexp . '(?:' . $this-&gt;_obj_ext_regexp . ')*\`)|(?:(?&lt;!\\\\)\$\w+(\[[a-zA-Z0-9]+\])*)~', $var_expr, $_match)) {
<a name="line1696"></a>            $_match = $_match[0];
<a name="line1697"></a>            $_replace = array();
<a name="line1698"></a>            foreach($_match as $_var) {
<a name="line1699"></a>                $_replace[$_var] = '&quot;.(' . $this-&gt;_parse_var(str_replace('`','',$_var)) . ').&quot;';
<a name="line1700"></a>            }
<a name="line1701"></a>            $var_expr = strtr($var_expr, $_replace);
<a name="line1702"></a>            $_return = preg_replace('~\.&quot;&quot;|(?&lt;!\\\\)&quot;&quot;\.~', '', $var_expr);
<a name="line1703"></a>        } else {
<a name="line1704"></a>            $_return = $var_expr;
<a name="line1705"></a>        }
<a name="line1706"></a>        // replace double quoted literal string with single quotes
<a name="line1707"></a>        $_return = preg_replace('~^&quot;([\s\w]+)&quot;$~',&quot;'\\1'&quot;,$_return);
<a name="line1708"></a>        // escape dollar sign if not printing a var
<a name="line1709"></a>        $_return = preg_replace('~\$(\W)~',&quot;\\\\\$\\1&quot;,$_return);
<a name="line1710"></a>        return $_return;
<a name="line1711"></a>    }
<a name="line1712"></a>&nbsp;
<a name="line1713"></a>    /**
<a name="line1714"></a>     * parse variable expression into PHP code
<a name="line1715"></a>     *
<a name="line1716"></a>     * @param string $var_expr
<a name="line1717"></a>     * @param string $output
<a name="line1718"></a>     * @return string
<a name="line1719"></a>     */
<a name="line1720"></a>    function _parse_var($var_expr)
<a name="line1721"></a>    {
<a name="line1722"></a>        $_has_math = false;
<a name="line1723"></a>        $_has_php4_method_chaining = false;
<a name="line1724"></a>        $_math_vars = preg_split('~('.$this-&gt;_dvar_math_regexp.'|'.$this-&gt;_qstr_regexp.')~', $var_expr, -1, PREG_SPLIT_DELIM_CAPTURE);
<a name="line1725"></a>&nbsp;
<a name="line1726"></a>        if(count($_math_vars) &gt; 1) {
<a name="line1727"></a>            $_first_var = &quot;&quot;;
<a name="line1728"></a>            $_complete_var = &quot;&quot;;
<a name="line1729"></a>            $_output = &quot;&quot;;
<a name="line1730"></a>            // simple check if there is any math, to stop recursion (due to modifiers with &quot;xx % yy&quot; as parameter)
<a name="line1731"></a>            foreach($_math_vars as $_k =&gt; $_math_var) {
<a name="line1732"></a>                $_math_var = $_math_vars[$_k];
<a name="line1733"></a>&nbsp;
<a name="line1734"></a>                if(!empty($_math_var) || is_numeric($_math_var)) {
<a name="line1735"></a>                    // hit a math operator, so process the stuff which came before it
<a name="line1736"></a>                    if(preg_match('~^' . $this-&gt;_dvar_math_regexp . '$~', $_math_var)) {
<a name="line1737"></a>                        $_has_math = true;
<a name="line1738"></a>                        if(!empty($_complete_var) || is_numeric($_complete_var)) {
<a name="line1739"></a>                            $_output .= $this-&gt;_parse_var($_complete_var);
<a name="line1740"></a>                        }
<a name="line1741"></a>&nbsp;
<a name="line1742"></a>                        // just output the math operator to php
<a name="line1743"></a>                        $_output .= $_math_var;
<a name="line1744"></a>&nbsp;
<a name="line1745"></a>                        if(empty($_first_var))
<a name="line1746"></a>                            $_first_var = $_complete_var;
<a name="line1747"></a>&nbsp;
<a name="line1748"></a>                        $_complete_var = &quot;&quot;;
<a name="line1749"></a>                    } else {
<a name="line1750"></a>                        $_complete_var .= $_math_var;
<a name="line1751"></a>                    }
<a name="line1752"></a>                }
<a name="line1753"></a>            }
<a name="line1754"></a>            if($_has_math) {
<a name="line1755"></a>                if(!empty($_complete_var) || is_numeric($_complete_var))
<a name="line1756"></a>                    $_output .= $this-&gt;_parse_var($_complete_var);
<a name="line1757"></a>&nbsp;
<a name="line1758"></a>                // get the modifiers working (only the last var from math + modifier is left)
<a name="line1759"></a>                $var_expr = $_complete_var;
<a name="line1760"></a>            }
<a name="line1761"></a>        }
<a name="line1762"></a>&nbsp;
<a name="line1763"></a>        // prevent cutting of first digit in the number (we _definitly_ got a number if the first char is a digit)
<a name="line1764"></a>        if(is_numeric(substr($var_expr, 0, 1)))
<a name="line1765"></a>            $_var_ref = $var_expr;
<a name="line1766"></a>        else
<a name="line1767"></a>            $_var_ref = substr($var_expr, 1);
<a name="line1768"></a>&nbsp;
<a name="line1769"></a>        if(!$_has_math) {
<a name="line1770"></a>&nbsp;
<a name="line1771"></a>            // get [foo] and .foo and -&gt;foo and (...) pieces
<a name="line1772"></a>            preg_match_all('~(?:^\w+)|' . $this-&gt;_obj_params_regexp . '|(?:' . $this-&gt;_var_bracket_regexp . ')|-&gt;\$?\w+|\.\$?\w+|\S+~', $_var_ref, $match);
<a name="line1773"></a>&nbsp;
<a name="line1774"></a>            $_indexes = $match[0];
<a name="line1775"></a>            $_var_name = array_shift($_indexes);
<a name="line1776"></a>&nbsp;
<a name="line1777"></a>            /* Handle $smarty.* variable references as a special case. */
<a name="line1778"></a>            if ($_var_name == 'smarty') {
<a name="line1779"></a>                /*
<a name="line1780"></a>                 * If the reference could be compiled, use the compiled output;
<a name="line1781"></a>                 * otherwise, fall back on the $smarty variable generated at
<a name="line1782"></a>                 * run-time.
<a name="line1783"></a>                 */
<a name="line1784"></a>                if (($smarty_ref = $this-&gt;_compile_smarty_ref($_indexes)) !== null) {
<a name="line1785"></a>                    $_output = $smarty_ref;
<a name="line1786"></a>                } else {
<a name="line1787"></a>                    $_var_name = substr(array_shift($_indexes), 1);
<a name="line1788"></a>                    $_output = &quot;\$this-&gt;_smarty_vars['$_var_name']&quot;;
<a name="line1789"></a>                }
<a name="line1790"></a>            } elseif(is_numeric($_var_name) &amp;&amp; is_numeric(substr($var_expr, 0, 1))) {
<a name="line1791"></a>                // because . is the operator for accessing arrays thru inidizes we need to put it together again for floating point numbers
<a name="line1792"></a>                if(count($_indexes) &gt; 0)
<a name="line1793"></a>                {
<a name="line1794"></a>                    $_var_name .= implode(&quot;&quot;, $_indexes);
<a name="line1795"></a>                    $_indexes = array();
<a name="line1796"></a>                }
<a name="line1797"></a>                $_output = $_var_name;
<a name="line1798"></a>            } else {
<a name="line1799"></a>                $_output = &quot;\$this-&gt;_tpl_vars['$_var_name']&quot;;
<a name="line1800"></a>            }
<a name="line1801"></a>&nbsp;
<a name="line1802"></a>            foreach ($_indexes as $_index) {
<a name="line1803"></a>                if (substr($_index, 0, 1) == '[') {
<a name="line1804"></a>                    $_index = substr($_index, 1, -1);
<a name="line1805"></a>                    if (is_numeric($_index)) {
<a name="line1806"></a>                        $_output .= &quot;[$_index]&quot;;
<a name="line1807"></a>                    } elseif (substr($_index, 0, 1) == '$') {
<a name="line1808"></a>                        if (strpos($_index, '.') !== false) {
<a name="line1809"></a>                            $_output .= '[' . $this-&gt;_parse_var($_index) . ']';
<a name="line1810"></a>                        } else {
<a name="line1811"></a>                            $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 1) . &quot;']]&quot;;
<a name="line1812"></a>                        }
<a name="line1813"></a>                    } else {
<a name="line1814"></a>                        $_var_parts = explode('.', $_index);
<a name="line1815"></a>                        $_var_section = $_var_parts[0];
<a name="line1816"></a>                        $_var_section_prop = isset($_var_parts[1]) ? $_var_parts[1] : 'index';
<a name="line1817"></a>                        $_output .= &quot;[\$this-&gt;_sections['$_var_section']['$_var_section_prop']]&quot;;
<a name="line1818"></a>                    }
<a name="line1819"></a>                } else if (substr($_index, 0, 1) == '.') {
<a name="line1820"></a>                    if (substr($_index, 1, 1) == '$')
<a name="line1821"></a>                        $_output .= &quot;[\$this-&gt;_tpl_vars['&quot; . substr($_index, 2) . &quot;']]&quot;;
<a name="line1822"></a>                    else
<a name="line1823"></a>                        $_output .= &quot;['&quot; . substr($_index, 1) . &quot;']&quot;;
<a name="line1824"></a>                } else if (substr($_index,0,2) == '-&gt;') {
<a name="line1825"></a>                    if(substr($_index,2,2) == '__') {
<a name="line1826"></a>                        $this-&gt;_syntax_error('call to internal object members is not allowed', E_USER_ERROR, __FILE__, __LINE__);
<a name="line1827"></a>                    } elseif($this-&gt;security &amp;&amp; substr($_index, 2, 1) == '_') {
<a name="line1828"></a>                        $this-&gt;_syntax_error('(secure) call to private object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
<a name="line1829"></a>                    } elseif (substr($_index, 2, 1) == '$') {
<a name="line1830"></a>                        if ($this-&gt;security) {
<a name="line1831"></a>                            $this-&gt;_syntax_error('(secure) call to dynamic object member is not allowed', E_USER_ERROR, __FILE__, __LINE__);
<a name="line1832"></a>                        } else {
<a name="line1833"></a>                            $_output .= '-&gt;{(($_var=$this-&gt;_tpl_vars[\''.substr($_index,3).'\']) &amp;&amp; substr($_var,0,2)!=\'__\') ? $_var : $this-&gt;trigger_error(&quot;cannot access property \\&quot;$_var\\&quot;&quot;)}';
<a name="line1834"></a>                        }
<a name="line1835"></a>                    } else {
<a name="line1836"></a>                       if ($this-&gt;_phpversion &lt; 5) {
<a name="line1837"></a>                         $_has_php4_method_chaining = true;
<a name="line1838"></a>                         $_output .= &quot;; \$_foo = \$_foo&quot;;
<a name="line1839"></a>                       }
<a name="line1840"></a>                        $_output .= $_index;
<a name="line1841"></a>                    }
<a name="line1842"></a>                } elseif (substr($_index, 0, 1) == '(') {
<a name="line1843"></a>                    $_index = $this-&gt;_parse_parenth_args($_index);
<a name="line1844"></a>                    $_output .= $_index;
<a name="line1845"></a>                } else {
<a name="line1846"></a>                    $_output .= $_index;
<a name="line1847"></a>                }
<a name="line1848"></a>            }
<a name="line1849"></a>        }
<a name="line1850"></a>&nbsp;
<a name="line1851"></a>        if ($_has_php4_method_chaining) {
<a name="line1852"></a>           $_tmp = str_replace(&quot;'&quot;,&quot;\'&quot;,'$_foo = '.$_output.'; return $_foo;');
<a name="line1853"></a>           return &quot;eval('&quot;.$_tmp.&quot;')&quot;;
<a name="line1854"></a>        } else {
<a name="line1855"></a>           return $_output; 
<a name="line1856"></a>        }
<a name="line1857"></a>    }
<a name="line1858"></a>&nbsp;
<a name="line1859"></a>    /**
<a name="line1860"></a>     * parse arguments in function call parenthesis
<a name="line1861"></a>     *
<a name="line1862"></a>     * @param string $parenth_args
<a name="line1863"></a>     * @return string
<a name="line1864"></a>     */
<a name="line1865"></a>    function _parse_parenth_args($parenth_args)
<a name="line1866"></a>    {
<a name="line1867"></a>        preg_match_all('~' . $this-&gt;_param_regexp . '~',$parenth_args, $match);
<a name="line1868"></a>        $orig_vals = $match = $match[0];
<a name="line1869"></a>        $this-&gt;_parse_vars_props($match);
<a name="line1870"></a>        $replace = array();
<a name="line1871"></a>        for ($i = 0, $count = count($match); $i &lt; $count; $i++) {
<a name="line1872"></a>            $replace[$orig_vals[$i]] = $match[$i];
<a name="line1873"></a>        }
<a name="line1874"></a>        return strtr($parenth_args, $replace);
<a name="line1875"></a>    }
<a name="line1876"></a>&nbsp;
<a name="line1877"></a>    /**
<a name="line1878"></a>     * parse configuration variable expression into PHP code
<a name="line1879"></a>     *
<a name="line1880"></a>     * @param string $conf_var_expr
<a name="line1881"></a>     */
<a name="line1882"></a>    function _parse_conf_var($conf_var_expr)
<a name="line1883"></a>    {
<a name="line1884"></a>        $parts = explode('|', $conf_var_expr, 2);
<a name="line1885"></a>        $var_ref = $parts[0];
<a name="line1886"></a>        $modifiers = isset($parts[1]) ? $parts[1] : '';
<a name="line1887"></a>&nbsp;
<a name="line1888"></a>        $var_name = substr($var_ref, 1, -1);
<a name="line1889"></a>&nbsp;
<a name="line1890"></a>        $output = &quot;\$this-&gt;_config[0]['vars']['$var_name']&quot;;
<a name="line1891"></a>&nbsp;
<a name="line1892"></a>        $this-&gt;_parse_modifiers($output, $modifiers);
<a name="line1893"></a>&nbsp;
<a name="line1894"></a>        return $output;
<a name="line1895"></a>    }
<a name="line1896"></a>&nbsp;
<a name="line1897"></a>    /**
<a name="line1898"></a>     * parse section property expression into PHP code
<a name="line1899"></a>     *
<a name="line1900"></a>     * @param string $section_prop_expr
<a name="line1901"></a>     * @return string
<a name="line1902"></a>     */
<a name="line1903"></a>    function _parse_section_prop($section_prop_expr)
<a name="line1904"></a>    {
<a name="line1905"></a>        $parts = explode('|', $section_prop_expr, 2);
<a name="line1906"></a>        $var_ref = $parts[0];
<a name="line1907"></a>        $modifiers = isset($parts[1]) ? $parts[1] : '';
<a name="line1908"></a>&nbsp;
<a name="line1909"></a>        preg_match('!%(\w+)\.(\w+)%!', $var_ref, $match);
<a name="line1910"></a>        $section_name = $match[1];
<a name="line1911"></a>        $prop_name = $match[2];
<a name="line1912"></a>&nbsp;
<a name="line1913"></a>        $output = &quot;\$this-&gt;_sections['$section_name']['$prop_name']&quot;;
<a name="line1914"></a>&nbsp;
<a name="line1915"></a>        $this-&gt;_parse_modifiers($output, $modifiers);
<a name="line1916"></a>&nbsp;
<a name="line1917"></a>        return $output;
<a name="line1918"></a>    }
<a name="line1919"></a>&nbsp;
<a name="line1920"></a>&nbsp;
<a name="line1921"></a>    /**
<a name="line1922"></a>     * parse modifier chain into PHP code
<a name="line1923"></a>     *
<a name="line1924"></a>     * sets $output to parsed modified chain
<a name="line1925"></a>     * @param string $output
<a name="line1926"></a>     * @param string $modifier_string
<a name="line1927"></a>     */
<a name="line1928"></a>    function _parse_modifiers(&amp;$output, $modifier_string)
<a name="line1929"></a>    {
<a name="line1930"></a>        preg_match_all('~\|(@?\w+)((?&gt;:(?:'. $this-&gt;_qstr_regexp . '|[^|]+))*)~', '|' . $modifier_string, $_match);
<a name="line1931"></a>        list(, $_modifiers, $modifier_arg_strings) = $_match;
<a name="line1932"></a>&nbsp;
<a name="line1933"></a>        for ($_i = 0, $_for_max = count($_modifiers); $_i &lt; $_for_max; $_i++) {
<a name="line1934"></a>            $_modifier_name = $_modifiers[$_i];
<a name="line1935"></a>&nbsp;
<a name="line1936"></a>            if($_modifier_name == 'smarty') {
<a name="line1937"></a>                // skip smarty modifier
<a name="line1938"></a>                continue;
<a name="line1939"></a>            }
<a name="line1940"></a>&nbsp;
<a name="line1941"></a>            preg_match_all('~:(' . $this-&gt;_qstr_regexp . '|[^:]+)~', $modifier_arg_strings[$_i], $_match);
<a name="line1942"></a>            $_modifier_args = $_match[1];
<a name="line1943"></a>&nbsp;
<a name="line1944"></a>            if (substr($_modifier_name, 0, 1) == '@') {
<a name="line1945"></a>                $_map_array = false;
<a name="line1946"></a>                $_modifier_name = substr($_modifier_name, 1);
<a name="line1947"></a>            } else {
<a name="line1948"></a>                $_map_array = true;
<a name="line1949"></a>            }
<a name="line1950"></a>&nbsp;
<a name="line1951"></a>            if (empty($this-&gt;_plugins['modifier'][$_modifier_name])
<a name="line1952"></a>                &amp;&amp; !$this-&gt;_get_plugin_filepath('modifier', $_modifier_name)
<a name="line1953"></a>                &amp;&amp; function_exists($_modifier_name)) {
<a name="line1954"></a>                if ($this-&gt;security &amp;&amp; !in_array($_modifier_name, $this-&gt;security_settings['MODIFIER_FUNCS'])) {
<a name="line1955"></a>                    $this-&gt;_trigger_fatal_error(&quot;[plugin] (secure mode) modifier '$_modifier_name' is not allowed&quot; , $this-&gt;_current_file, $this-&gt;_current_line_no, __FILE__, __LINE__);
<a name="line1956"></a>                } else {
<a name="line1957"></a>                    $this-&gt;_plugins['modifier'][$_modifier_name] = array($_modifier_name,  null, null, false);
<a name="line1958"></a>                }
<a name="line1959"></a>            }
<a name="line1960"></a>            $this-&gt;_add_plugin('modifier', $_modifier_name);
<a name="line1961"></a>&nbsp;
<a name="line1962"></a>            $this-&gt;_parse_vars_props($_modifier_args);
<a name="line1963"></a>&nbsp;
<a name="line1964"></a>            if($_modifier_name == 'default') {
<a name="line1965"></a>                // supress notifications of default modifier vars and args
<a name="line1966"></a>                if(substr($output, 0, 1) == '$') {
<a name="line1967"></a>                    $output = '@' . $output;
<a name="line1968"></a>                }
<a name="line1969"></a>                if(isset($_modifier_args[0]) &amp;&amp; substr($_modifier_args[0], 0, 1) == '$') {
<a name="line1970"></a>                    $_modifier_args[0] = '@' . $_modifier_args[0];
<a name="line1971"></a>                }
<a name="line1972"></a>            }
<a name="line1973"></a>            if (count($_modifier_args) &gt; 0)
<a name="line1974"></a>                $_modifier_args = ', '.implode(', ', $_modifier_args);
<a name="line1975"></a>            else
<a name="line1976"></a>                $_modifier_args = '';
<a name="line1977"></a>&nbsp;
<a name="line1978"></a>            if ($_map_array) {
<a name="line1979"></a>                $output = &quot;((is_array(\$_tmp=$output)) ? \$this-&gt;_run_mod_handler('$_modifier_name', true, \$_tmp$_modifier_args) : &quot; . $this-&gt;_compile_plugin_call('modifier', $_modifier_name) . &quot;(\$_tmp$_modifier_args))&quot;;
<a name="line1980"></a>&nbsp;
<a name="line1981"></a>            } else {
<a name="line1982"></a>&nbsp;
<a name="line1983"></a>                $output = $this-&gt;_compile_plugin_call('modifier', $_modifier_name).&quot;($output$_modifier_args)&quot;;
<a name="line1984"></a>&nbsp;
<a name="line1985"></a>            }
<a name="line1986"></a>        }
<a name="line1987"></a>    }
<a name="line1988"></a>&nbsp;
<a name="line1989"></a>&nbsp;
<a name="line1990"></a>    /**
<a name="line1991"></a>     * add plugin
<a name="line1992"></a>     *
<a name="line1993"></a>     * @param string $type
<a name="line1994"></a>     * @param string $name
<a name="line1995"></a>     * @param boolean? $delayed_loading
<a name="line1996"></a>     */
<a name="line1997"></a>    function _add_plugin($type, $name, $delayed_loading = null)
<a name="line1998"></a>    {
<a name="line1999"></a>        if (!isset($this-&gt;_plugin_info[$type])) {
<a name="line2000"></a>            $this-&gt;_plugin_info[$type] = array();
<a name="line2001"></a>        }
<a name="line2002"></a>        if (!isset($this-&gt;_plugin_info[$type][$name])) {
<a name="line2003"></a>            $this-&gt;_plugin_info[$type][$name] = array($this-&gt;_current_file,
<a name="line2004"></a>                                                      $this-&gt;_current_line_no,
<a name="line2005"></a>                                                      $delayed_loading);
<a name="line2006"></a>        }
<a name="line2007"></a>    }
<a name="line2008"></a>&nbsp;
<a name="line2009"></a>&nbsp;
<a name="line2010"></a>    /**
<a name="line2011"></a>     * Compiles references of type $smarty.foo
<a name="line2012"></a>     *
<a name="line2013"></a>     * @param string $indexes
<a name="line2014"></a>     * @return string
<a name="line2015"></a>     */
<a name="line2016"></a>    function _compile_smarty_ref(&amp;$indexes)
<a name="line2017"></a>    {
<a name="line2018"></a>        /* Extract the reference name. */
<a name="line2019"></a>        $_ref = substr($indexes[0], 1);
<a name="line2020"></a>        foreach($indexes as $_index_no=&gt;$_index) {
<a name="line2021"></a>            if (substr($_index, 0, 1) != '.' &amp;&amp; $_index_no&lt;2 || !preg_match('~^(\.|\[|-&gt;)~', $_index)) {
<a name="line2022"></a>                $this-&gt;_syntax_error('$smarty' . implode('', array_slice($indexes, 0, 2)) . ' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
<a name="line2023"></a>            }
<a name="line2024"></a>        }
<a name="line2025"></a>&nbsp;
<a name="line2026"></a>        switch ($_ref) {
<a name="line2027"></a>            case 'now':
<a name="line2028"></a>                $compiled_ref = 'time()';
<a name="line2029"></a>                $_max_index = 1;
<a name="line2030"></a>                break;
<a name="line2031"></a>&nbsp;
<a name="line2032"></a>            case 'foreach':
<a name="line2033"></a>                array_shift($indexes);
<a name="line2034"></a>                $_var = $this-&gt;_parse_var_props(substr($indexes[0], 1));
<a name="line2035"></a>                $_propname = substr($indexes[1], 1);
<a name="line2036"></a>                $_max_index = 1;
<a name="line2037"></a>                switch ($_propname) {
<a name="line2038"></a>                    case 'index':
<a name="line2039"></a>                        array_shift($indexes);
<a name="line2040"></a>                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration']-1)&quot;;
<a name="line2041"></a>                        break;
<a name="line2042"></a>&nbsp;
<a name="line2043"></a>                    case 'first':
<a name="line2044"></a>                        array_shift($indexes);
<a name="line2045"></a>                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration'] &lt;= 1)&quot;;
<a name="line2046"></a>                        break;
<a name="line2047"></a>&nbsp;
<a name="line2048"></a>                    case 'last':
<a name="line2049"></a>                        array_shift($indexes);
<a name="line2050"></a>                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['iteration'] == \$this-&gt;_foreach[$_var]['total'])&quot;;
<a name="line2051"></a>                        break;
<a name="line2052"></a>&nbsp;
<a name="line2053"></a>                    case 'show':
<a name="line2054"></a>                        array_shift($indexes);
<a name="line2055"></a>                        $compiled_ref = &quot;(\$this-&gt;_foreach[$_var]['total'] &gt; 0)&quot;;
<a name="line2056"></a>                        break;
<a name="line2057"></a>&nbsp;
<a name="line2058"></a>                    default:
<a name="line2059"></a>                        unset($_max_index);
<a name="line2060"></a>                        $compiled_ref = &quot;\$this-&gt;_foreach[$_var]&quot;;
<a name="line2061"></a>                }
<a name="line2062"></a>                break;
<a name="line2063"></a>&nbsp;
<a name="line2064"></a>            case 'section':
<a name="line2065"></a>                array_shift($indexes);
<a name="line2066"></a>                $_var = $this-&gt;_parse_var_props(substr($indexes[0], 1));
<a name="line2067"></a>                $compiled_ref = &quot;\$this-&gt;_sections[$_var]&quot;;
<a name="line2068"></a>                break;
<a name="line2069"></a>&nbsp;
<a name="line2070"></a>            case 'get':
<a name="line2071"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_GET' : &quot;\$GLOBALS['HTTP_GET_VARS']&quot;;
<a name="line2072"></a>                break;
<a name="line2073"></a>&nbsp;
<a name="line2074"></a>            case 'post':
<a name="line2075"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_POST' : &quot;\$GLOBALS['HTTP_POST_VARS']&quot;;
<a name="line2076"></a>                break;
<a name="line2077"></a>&nbsp;
<a name="line2078"></a>            case 'cookies':
<a name="line2079"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_COOKIE' : &quot;\$GLOBALS['HTTP_COOKIE_VARS']&quot;;
<a name="line2080"></a>                break;
<a name="line2081"></a>&nbsp;
<a name="line2082"></a>            case 'env':
<a name="line2083"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_ENV' : &quot;\$GLOBALS['HTTP_ENV_VARS']&quot;;
<a name="line2084"></a>                break;
<a name="line2085"></a>&nbsp;
<a name="line2086"></a>            case 'server':
<a name="line2087"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SERVER' : &quot;\$GLOBALS['HTTP_SERVER_VARS']&quot;;
<a name="line2088"></a>                break;
<a name="line2089"></a>&nbsp;
<a name="line2090"></a>            case 'session':
<a name="line2091"></a>                $compiled_ref = ($this-&gt;request_use_auto_globals) ? '$_SESSION' : &quot;\$GLOBALS['HTTP_SESSION_VARS']&quot;;
<a name="line2092"></a>                break;
<a name="line2093"></a>&nbsp;
<a name="line2094"></a>            /*
<a name="line2095"></a>             * These cases are handled either at run-time or elsewhere in the
<a name="line2096"></a>             * compiler.
<a name="line2097"></a>             */
<a name="line2098"></a>            case 'request':
<a name="line2099"></a>                if ($this-&gt;request_use_auto_globals) {
<a name="line2100"></a>                    $compiled_ref = '$_REQUEST';
<a name="line2101"></a>                    break;
<a name="line2102"></a>                } else {
<a name="line2103"></a>                    $this-&gt;_init_smarty_vars = true;
<a name="line2104"></a>                }
<a name="line2105"></a>                return null;
<a name="line2106"></a>&nbsp;
<a name="line2107"></a>            case 'capture':
<a name="line2108"></a>                return null;
<a name="line2109"></a>&nbsp;
<a name="line2110"></a>            case 'template':
<a name="line2111"></a>                $compiled_ref = &quot;'$this-&gt;_current_file'&quot;;
<a name="line2112"></a>                $_max_index = 1;
<a name="line2113"></a>                break;
<a name="line2114"></a>&nbsp;
<a name="line2115"></a>            case 'version':
<a name="line2116"></a>                $compiled_ref = &quot;'$this-&gt;_version'&quot;;
<a name="line2117"></a>                $_max_index = 1;
<a name="line2118"></a>                break;
<a name="line2119"></a>&nbsp;
<a name="line2120"></a>            case 'const':
<a name="line2121"></a>                if ($this-&gt;security &amp;&amp; !$this-&gt;security_settings['ALLOW_CONSTANTS']) {
<a name="line2122"></a>                    $this-&gt;_syntax_error(&quot;(secure mode) constants not permitted&quot;,
<a name="line2123"></a>                                         E_USER_WARNING, __FILE__, __LINE__);
<a name="line2124"></a>                    return;
<a name="line2125"></a>                }
<a name="line2126"></a>                array_shift($indexes);
<a name="line2127"></a>                if (preg_match('!^\.\w+$!', $indexes[0])) {
<a name="line2128"></a>                    $compiled_ref = '@' . substr($indexes[0], 1);
<a name="line2129"></a>                } else {
<a name="line2130"></a>                    $_val = $this-&gt;_parse_var_props(substr($indexes[0], 1));
<a name="line2131"></a>                    $compiled_ref = '@constant(' . $_val . ')';
<a name="line2132"></a>                }
<a name="line2133"></a>                $_max_index = 1;
<a name="line2134"></a>                break;
<a name="line2135"></a>&nbsp;
<a name="line2136"></a>            case 'config':
<a name="line2137"></a>                $compiled_ref = &quot;\$this-&gt;_config[0]['vars']&quot;;
<a name="line2138"></a>                $_max_index = 3;
<a name="line2139"></a>                break;
<a name="line2140"></a>&nbsp;
<a name="line2141"></a>            case 'ldelim':
<a name="line2142"></a>                $compiled_ref = &quot;'$this-&gt;left_delimiter'&quot;;
<a name="line2143"></a>                break;
<a name="line2144"></a>&nbsp;
<a name="line2145"></a>            case 'rdelim':
<a name="line2146"></a>                $compiled_ref = &quot;'$this-&gt;right_delimiter'&quot;;
<a name="line2147"></a>                break;
<a name="line2148"></a>&nbsp;
<a name="line2149"></a>            default:
<a name="line2150"></a>                $this-&gt;_syntax_error('$smarty.' . $_ref . ' is an unknown reference', E_USER_ERROR, __FILE__, __LINE__);
<a name="line2151"></a>                break;
<a name="line2152"></a>        }
<a name="line2153"></a>&nbsp;
<a name="line2154"></a>        if (isset($_max_index) &amp;&amp; count($indexes) &gt; $_max_index) {
<a name="line2155"></a>            $this-&gt;_syntax_error('$smarty' . implode('', $indexes) .' is an invalid reference', E_USER_ERROR, __FILE__, __LINE__);
<a name="line2156"></a>        }
<a name="line2157"></a>&nbsp;
<a name="line2158"></a>        array_shift($indexes);
<a name="line2159"></a>        return $compiled_ref;
<a name="line2160"></a>    }
<a name="line2161"></a>&nbsp;
<a name="line2162"></a>    /**
<a name="line2163"></a>     * compiles call to plugin of type $type with name $name
<a name="line2164"></a>     * returns a string containing the function-name or method call
<a name="line2165"></a>     * without the paramter-list that would have follow to make the
<a name="line2166"></a>     * call valid php-syntax
<a name="line2167"></a>     *
<a name="line2168"></a>     * @param string $type
<a name="line2169"></a>     * @param string $name
<a name="line2170"></a>     * @return string
<a name="line2171"></a>     */
<a name="line2172"></a>    function _compile_plugin_call($type, $name) {
<a name="line2173"></a>        if (isset($this-&gt;_plugins[$type][$name])) {
<a name="line2174"></a>            /* plugin loaded */
<a name="line2175"></a>            if (is_array($this-&gt;_plugins[$type][$name][0])) {
<a name="line2176"></a>                return ((is_object($this-&gt;_plugins[$type][$name][0][0])) ?
<a name="line2177"></a>                        &quot;\$this-&gt;_plugins['$type']['$name'][0][0]-&gt;&quot;    /* method callback */
<a name="line2178"></a>                        : (string)($this-&gt;_plugins[$type][$name][0][0]).'::'    /* class callback */
<a name="line2179"></a>                       ). $this-&gt;_plugins[$type][$name][0][1];
<a name="line2180"></a>&nbsp;
<a name="line2181"></a>            } else {
<a name="line2182"></a>                /* function callback */
<a name="line2183"></a>                return $this-&gt;_plugins[$type][$name][0];
<a name="line2184"></a>&nbsp;
<a name="line2185"></a>            }
<a name="line2186"></a>        } else {
<a name="line2187"></a>            /* plugin not loaded -&gt; auto-loadable-plugin */
<a name="line2188"></a>            return 'smarty_'.$type.'_'.$name;
<a name="line2189"></a>&nbsp;
<a name="line2190"></a>        }
<a name="line2191"></a>    }
<a name="line2192"></a>&nbsp;
<a name="line2193"></a>    /**
<a name="line2194"></a>     * load pre- and post-filters
<a name="line2195"></a>     */
<a name="line2196"></a>    function _load_filters()
<a name="line2197"></a>    {
<a name="line2198"></a>        if (count($this-&gt;_plugins['prefilter']) &gt; 0) {
<a name="line2199"></a>            foreach ($this-&gt;_plugins['prefilter'] as $filter_name =&gt; $prefilter) {
<a name="line2200"></a>                if ($prefilter === false) {
<a name="line2201"></a>                    unset($this-&gt;_plugins['prefilter'][$filter_name]);
<a name="line2202"></a>                    $_params = array('plugins' =&gt; array(array('prefilter', $filter_name, null, null, false)));
<a name="line2203"></a>                    require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
<a name="line2204"></a>                    smarty_core_load_plugins($_params, $this);
<a name="line2205"></a>                }
<a name="line2206"></a>            }
<a name="line2207"></a>        }
<a name="line2208"></a>        if (count($this-&gt;_plugins['postfilter']) &gt; 0) {
<a name="line2209"></a>            foreach ($this-&gt;_plugins['postfilter'] as $filter_name =&gt; $postfilter) {
<a name="line2210"></a>                if ($postfilter === false) {
<a name="line2211"></a>                    unset($this-&gt;_plugins['postfilter'][$filter_name]);
<a name="line2212"></a>                    $_params = array('plugins' =&gt; array(array('postfilter', $filter_name, null, null, false)));
<a name="line2213"></a>                    require_once(SMARTY_CORE_DIR . 'core.load_plugins.php');
<a name="line2214"></a>                    smarty_core_load_plugins($_params, $this);
<a name="line2215"></a>                }
<a name="line2216"></a>            }
<a name="line2217"></a>        }
<a name="line2218"></a>    }
<a name="line2219"></a>&nbsp;
<a name="line2220"></a>&nbsp;
<a name="line2221"></a>    /**
<a name="line2222"></a>     * Quote subpattern references
<a name="line2223"></a>     *
<a name="line2224"></a>     * @param string $string
<a name="line2225"></a>     * @return string
<a name="line2226"></a>     */
<a name="line2227"></a>    function _quote_replace($string)
<a name="line2228"></a>    {
<a name="line2229"></a>        return strtr($string, array('\\' =&gt; '\\\\', '$' =&gt; '\\$'));
<a name="line2230"></a>    }
<a name="line2231"></a>&nbsp;
<a name="line2232"></a>    /**
<a name="line2233"></a>     * display Smarty syntax error
<a name="line2234"></a>     *
<a name="line2235"></a>     * @param string $error_msg
<a name="line2236"></a>     * @param integer $error_type
<a name="line2237"></a>     * @param string $file
<a name="line2238"></a>     * @param integer $line
<a name="line2239"></a>     */
<a name="line2240"></a>    function _syntax_error($error_msg, $error_type = E_USER_ERROR, $file=null, $line=null)
<a name="line2241"></a>    {
<a name="line2242"></a>        $this-&gt;_trigger_fatal_error(&quot;syntax error: $error_msg&quot;, $this-&gt;_current_file, $this-&gt;_current_line_no, $file, $line, $error_type);
<a name="line2243"></a>    }
<a name="line2244"></a>&nbsp;
<a name="line2245"></a>&nbsp;
<a name="line2246"></a>    /**
<a name="line2247"></a>     * check if the compilation changes from cacheable to
<a name="line2248"></a>     * non-cacheable state with the beginning of the current
<a name="line2249"></a>     * plugin. return php-code to reflect the transition.
<a name="line2250"></a>     * @return string
<a name="line2251"></a>     */
<a name="line2252"></a>    function _push_cacheable_state($type, $name) {
<a name="line2253"></a>        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
<a name="line2254"></a>        if ($_cacheable
<a name="line2255"></a>            || 0&lt;$this-&gt;_cacheable_state++) return '';
<a name="line2256"></a>        if (!isset($this-&gt;_cache_serial)) $this-&gt;_cache_serial = md5(uniqid('Smarty'));
<a name="line2257"></a>        $_ret = 'if ($this-&gt;caching &amp;&amp; !$this-&gt;_cache_including): echo \'{nocache:'
<a name="line2258"></a>            . $this-&gt;_cache_serial . '#' . $this-&gt;_nocache_count
<a name="line2259"></a>            . '}\'; endif;';
<a name="line2260"></a>        return $_ret;
<a name="line2261"></a>    }
<a name="line2262"></a>&nbsp;
<a name="line2263"></a>&nbsp;
<a name="line2264"></a>    /**
<a name="line2265"></a>     * check if the compilation changes from non-cacheable to
<a name="line2266"></a>     * cacheable state with the end of the current plugin return
<a name="line2267"></a>     * php-code to reflect the transition.
<a name="line2268"></a>     * @return string
<a name="line2269"></a>     */
<a name="line2270"></a>    function _pop_cacheable_state($type, $name) {
<a name="line2271"></a>        $_cacheable = !isset($this-&gt;_plugins[$type][$name]) || $this-&gt;_plugins[$type][$name][4];
<a name="line2272"></a>        if ($_cacheable
<a name="line2273"></a>            || --$this-&gt;_cacheable_state&gt;0) return '';
<a name="line2274"></a>        return 'if ($this-&gt;caching &amp;&amp; !$this-&gt;_cache_including): echo \'{/nocache:'
<a name="line2275"></a>            . $this-&gt;_cache_serial . '#' . ($this-&gt;_nocache_count++)
<a name="line2276"></a>            . '}\'; endif;';
<a name="line2277"></a>    }
<a name="line2278"></a>&nbsp;
<a name="line2279"></a>&nbsp;
<a name="line2280"></a>    /**
<a name="line2281"></a>     * push opening tag-name, file-name and line-number on the tag-stack
<a name="line2282"></a>     * @param string the opening tag's name
<a name="line2283"></a>     */
<a name="line2284"></a>    function _push_tag($open_tag)
<a name="line2285"></a>    {
<a name="line2286"></a>        array_push($this-&gt;_tag_stack, array($open_tag, $this-&gt;_current_line_no));
<a name="line2287"></a>    }
<a name="line2288"></a>&nbsp;
<a name="line2289"></a>    /**
<a name="line2290"></a>     * pop closing tag-name
<a name="line2291"></a>     * raise an error if this stack-top doesn't match with the closing tag
<a name="line2292"></a>     * @param string the closing tag's name
<a name="line2293"></a>     * @return string the opening tag's name
<a name="line2294"></a>     */
<a name="line2295"></a>    function _pop_tag($close_tag)
<a name="line2296"></a>    {
<a name="line2297"></a>        $message = '';
<a name="line2298"></a>        if (count($this-&gt;_tag_stack)&gt;0) {
<a name="line2299"></a>            list($_open_tag, $_line_no) = array_pop($this-&gt;_tag_stack);
<a name="line2300"></a>            if ($close_tag == $_open_tag) {
<a name="line2301"></a>                return $_open_tag;
<a name="line2302"></a>            }
<a name="line2303"></a>            if ($close_tag == 'if' &amp;&amp; ($_open_tag == 'else' || $_open_tag == 'elseif' )) {
<a name="line2304"></a>                return $this-&gt;_pop_tag($close_tag);
<a name="line2305"></a>            }
<a name="line2306"></a>            if ($close_tag == 'section' &amp;&amp; $_open_tag == 'sectionelse') {
<a name="line2307"></a>                $this-&gt;_pop_tag($close_tag);
<a name="line2308"></a>                return $_open_tag;
<a name="line2309"></a>            }
<a name="line2310"></a>            if ($close_tag == 'foreach' &amp;&amp; $_open_tag == 'foreachelse') {
<a name="line2311"></a>                $this-&gt;_pop_tag($close_tag);
<a name="line2312"></a>                return $_open_tag;
<a name="line2313"></a>            }
<a name="line2314"></a>            if ($_open_tag == 'else' || $_open_tag == 'elseif') {
<a name="line2315"></a>                $_open_tag = 'if';
<a name="line2316"></a>            } elseif ($_open_tag == 'sectionelse') {
<a name="line2317"></a>                $_open_tag = 'section';
<a name="line2318"></a>            } elseif ($_open_tag == 'foreachelse') {
<a name="line2319"></a>                $_open_tag = 'foreach';
<a name="line2320"></a>            }
<a name="line2321"></a>            $message = &quot; expected {/$_open_tag} (opened line $_line_no).&quot;;
<a name="line2322"></a>        }
<a name="line2323"></a>        $this-&gt;_syntax_error(&quot;mismatched tag {/$close_tag}.$message&quot;,
<a name="line2324"></a>                             E_USER_ERROR, __FILE__, __LINE__);
<a name="line2325"></a>    }
<a name="line2326"></a>&nbsp;
<a name="line2327"></a>}
<a name="line2328"></a>&nbsp;
<a name="line2329"></a>/**
<a name="line2330"></a> * compare to values by their string length
<a name="line2331"></a> *
<a name="line2332"></a> * @access private
<a name="line2333"></a> * @param string $a
<a name="line2334"></a> * @param string $b
<a name="line2335"></a> * @return 0|-1|1
<a name="line2336"></a> */
<a name="line2337"></a>function _smarty_sort_length($a, $b)
<a name="line2338"></a>{
<a name="line2339"></a>    if($a == $b)
<a name="line2340"></a>        return 0;
<a name="line2341"></a>&nbsp;
<a name="line2342"></a>    if(strlen($a) == strlen($b))
<a name="line2343"></a>        return ($a &gt; $b) ? -1 : 1;
<a name="line2344"></a>&nbsp;
<a name="line2345"></a>    return (strlen($a) &gt; strlen($b)) ? -1 : 1;
<a name="line2346"></a>}
<a name="line2347"></a>&nbsp;
<a name="line2348"></a>&nbsp;
<a name="line2349"></a>/* vim: set et: */
<a name="line2350"></a>&nbsp;
<a name="line2351"></a>?&gt;
<a name="line2352"></a>&nbsp;</pre>
<div class="header">
<h1>Smarty</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source/smarty_compiler.class.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>